<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="HandheldFriendly" content="True">
  <title>Elixir et framework Phoenix: formulaires et base de données - C. Boyer</title>
  <meta name="description" content="Le web avec Elixir et son framework Phoenix: formulaires et base de données." />
  <meta name="author" content="C. Boyer" />
  <meta name="keywords" content="Elixir, Phoenix, Ecto, crud, mix, iex" />
  <link rel="canonical" href="https://cboyer.github.io/developpement/elixir-phoenix-formulaires" />
  <meta property="og:title" content="Elixir et framework Phoenix: formulaires et base de données - C. Boyer" />
  <meta property="og:locale" content="fr_CA" />
  <meta property="og:description" content="Le web avec Elixir et son framework Phoenix: formulaires et base de données." />
  <meta property="og:site_name" content="cboyer.github.io" />
  <meta property="og:type" content="website" />
  <meta property="og:updated_time" content="2020-11-06T18:03:11-05:00" />
  <meta property="article:published_time" content="2020-11-06T18:03:11-05:00" />
  <meta property="article:modified_time" content="2020-11-06T18:03:11-05:00" />
  <meta name="generator" content="pandoc" />
  <meta name="robots" content="index,follow">
  <link rel="icon" href="data:;base64,iVBORw0KGgo=">
  <link href="https://cboyer.github.io/atom.xml" rel="alternate" type="application/atom+xml" />
  <link rel="stylesheet" type="text/css" href="../../style.css" />
  <style>
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style>
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    background-color: #ffffff;
    color: #a0a0a0;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #a0a0a0;  padding-left: 4px; }
div.sourceCode
  { color: #1f1c1b; background-color: #ffffff; }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span { color: #1f1c1b; } /* Normal */
code span.al { color: #bf0303; background-color: #f7e6e6; font-weight: bold; } /* Alert */
code span.an { color: #ca60ca; } /* Annotation */
code span.at { color: #0057ae; } /* Attribute */
code span.bn { color: #b08000; } /* BaseN */
code span.bu { color: #644a9b; font-weight: bold; } /* BuiltIn */
code span.cf { color: #1f1c1b; font-weight: bold; } /* ControlFlow */
code span.ch { color: #924c9d; } /* Char */
code span.cn { color: #aa5500; } /* Constant */
code span.co { color: #898887; } /* Comment */
code span.cv { color: #0095ff; } /* CommentVar */
code span.do { color: #607880; } /* Documentation */
code span.dt { color: #0057ae; } /* DataType */
code span.dv { color: #b08000; } /* DecVal */
code span.er { color: #bf0303; text-decoration: underline; } /* Error */
code span.ex { color: #0095ff; font-weight: bold; } /* Extension */
code span.fl { color: #b08000; } /* Float */
code span.fu { color: #644a9b; } /* Function */
code span.im { color: #ff5500; } /* Import */
code span.in { color: #b08000; } /* Information */
code span.kw { color: #1f1c1b; font-weight: bold; } /* Keyword */
code span.op { color: #1f1c1b; } /* Operator */
code span.ot { color: #006e28; } /* Other */
code span.pp { color: #006e28; } /* Preprocessor */
code span.re { color: #0057ae; background-color: #e0e9f8; } /* RegionMarker */
code span.sc { color: #3daee9; } /* SpecialChar */
code span.ss { color: #ff5500; } /* SpecialString */
code span.st { color: #bf0303; } /* String */
code span.va { color: #0057ae; } /* Variable */
code span.vs { color: #bf0303; } /* VerbatimString */
code span.wa { color: #bf0303; } /* Warning */
  </style>
</head>
<body>
  <div id="header">
    <div id="links">
      <a href="https://github.com/cboyer" class="github" title="GitHub" target="_blank">
          <svg class="button" aria-labelledby="github-icon" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <title id="github-icon">GitHub</title>
            <path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"></path>
          </svg>
      </a>
      <a href="../../atom.xml" class="rss" title="Flux Atom">
          <svg class="button" aria-labelledby="atom-icon" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <title id="atom-icon">Flux Atom</title>
            <path d="M19.199 24C19.199 13.467 10.533 4.8 0 4.8V0c13.165 0 24 10.835 24 24h-4.801zM3.291 17.415c1.814 0 3.293 1.479 3.293 3.295 0 1.813-1.485 3.29-3.301 3.29C1.47 24 0 22.526 0 20.71s1.475-3.294 3.291-3.295zM15.909 24h-4.665c0-6.169-5.075-11.245-11.244-11.245V8.09c8.727 0 15.909 7.184 15.909 15.91z"></path>
          </svg>
      </a>
    </div>
    <h1>cboyer.github.io</h1>
    <div id="menu">
      <a href="../../index.html">Index</a> | <a href="../../developpement.html">Développement</a> | <a href="../../linux.html">Linux</a> | <a href="../../electronique.html">Électronique</a>
    </div>
  </div>

  <div id="container">
<article>
<header id="title-block-header">
<h1 class="title">Elixir et framework Phoenix: formulaires et base de données</h1>
 <small class="date">2020-11-06T18:03:11-05:00</small>
</header>
<ul>
<li><a href="#installation">Installation de PostgreSQL</a></li>
<li><a href="#upgradephoenix">Mise à jour de Phoenix</a></li>
<li><a href="#projetecto">Création d'un projet Phoenix</a></li>
<li><a href="#schema">Création du schéma et des ressources Phoenix</a></li>
<li><a href="#selecttype">Ajouter la sélection du type de profile lors de la création d'un utilisateur</a></li>
<li><a href="#relation">Ajuster les relations pour afficher le nom du profil au lieu de son ID</a></li>
</ul>
<h2 id="installation-de-postgresql"><a name="installation"></a>Installation de PostgreSQL</h2>
<p>Pour installer et initialiser PostgreSQL sous Fedora:</p>
<pre class="console"><code>dnf install postgresql-server
/usr/bin/postgresql-setup --initdb</code></pre>
<p>Configurer le chiffrement des mots de passe dans <code>/var/lib/pgsql/data/postgresql.conf</code>:</p>
<pre class="console"><code>password_encryption = scram-sha-256</code></pre>
<p>Définir l'utilisation de mots de passe pour une connexion via localhost dans <code>/var/lib/pgsql/data/pg_hba.conf</code>:</p>
<pre class="console"><code>host    all             all             127.0.0.1/32            scram-sha-256</code></pre>
<p>Démarrer PostgreSQL et définir un mot de passe pour l'utilisateur <code>postgres</code>:</p>
<pre class="console"><code>systemctl restart postgresql
su - postgres
psql
ALTER USER postgres PASSWORD &#39;postgres&#39;;
\q
exit</code></pre>
<p>Installer PGAdmin4 peut être intéressant pour explorer la base de données: <a href="https://www.pgadmin.org/download/pgadmin-4-rpm/">https://www.pgadmin.org/download/pgadmin-4-rpm</a>.</p>
<h2 id="mise-à-jour-de-phoenix"><a name="upgradephoenix"></a>Mise à jour de Phoenix</h2>
<p>Pour mettre à jour Phoenix et/ou un projet déjà existant:</p>
<pre class="console"><code>#Mettre à jour la librairie
mix local.phx

#Changer la version requise de Phoenix dans un projet existant
vi mix.exs

#Nettoyage
mix deps.clean --all
mix clean --deps
rm -rf _build/ deps/ mix.lock

#Mise à jour
mix deps.get
mix compile

#Mettre à jour les assets JS (Webpack)
rm -rf assets/node_modules
npm install --prefix assets/</code></pre>
<h2 id="création-dun-projet-phoenix-incluant-ecto-pour-la-gestion-de-bases-de-donnée"><a name="projetecto"></a>Création d'un projet Phoenix (incluant Ecto pour la gestion de bases de donnée)</h2>
<p>L'exclusion de Webpack posera des problèmes: les requêtes <code>delete</code> seront sans effets, la vérification de champs <code>unique_constraint</code> dans un changeset également. Également les messages <code>put_flash</code> et <code>message:</code> dans les vérification de changeset seront moins élégants.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true"></a>mix local<span class="op">.</span>phx</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true"></a>mix phx<span class="op">.</span>new test_bd</span></code></pre></div>
<p>Configuration des accès à la base de données (environnement de développement) dans <code>config/dev.exs</code>:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true"></a><span class="co"># Configure your database</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true"></a>config <span class="va">:test_bd</span>, <span class="cn">TestBd</span><span class="op">.</span><span class="cn">Repo</span>,</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true"></a>  <span class="va">username:</span> <span class="st">&quot;postgres&quot;</span>,</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true"></a>  <span class="va">password:</span> <span class="st">&quot;postgres&quot;</span>,</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true"></a>  <span class="va">database:</span> <span class="st">&quot;test_bd_dev&quot;</span>,</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true"></a>  <span class="va">hostname:</span> <span class="st">&quot;localhost&quot;</span>,</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true"></a>  <span class="va">show_sensitive_data_on_connection_error:</span> <span class="cn">true</span>,</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true"></a>  <span class="va">pool_size:</span> <span class="dv">10</span></span></code></pre></div>
<h2 id="création-du-schéma-et-des-ressources-phoenix"><a name="schema"></a>Création du schéma et des ressources Phoenix</h2>
<p>Phoenix permet d'initialiser la base de données ainsi que tous les éléments nécessaires (controleurs, templates, vues, modèles) pour interragir avec des données (actions CRUD).</p>
<h3 id="générer-le-schéma-et-les-ressources">Générer le schéma et les ressources:</h3>
<p>Utiliser des contextes pour regrouper les fonctions générées selon une fonctionnalité de l'application (autentification, etc.) au lieu d'avoir un seul fichier très dense.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true"></a><span class="co">#Générer les controleurs, vues, et contextes pour les ressources HTML.</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true"></a><span class="co">#mix phx.gen.html [module contexte] [module schéma] [Schéma au pluriel (nom de la table)] [colonne1:type] [colonne2:type] ...</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true"></a>mix phx<span class="op">.</span>gen<span class="op">.</span>html <span class="cn">ContextProfile</span> <span class="cn">Profile</span> profiles <span class="va">profile:</span>string</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true"></a>mix phx<span class="op">.</span>gen<span class="op">.</span>html <span class="cn">ContextUser</span> <span class="cn">User</span> users <span class="va">name:</span>string <span class="va">profile_id:references:</span>profiles</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true"></a></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true"></a><span class="co">#Initialisation d&#39;Ecto et de la base de données avec la création des tables dans PostgreSQL</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true"></a>mix ecto<span class="op">.</span>create</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true"></a>mix ecto<span class="op">.</span>migrate</span></code></pre></div>
<p>Les fichiers suivants seront crées:</p>
<pre class="console"><code>lib/test_bd/
├── context_profile
│   └── profile.ex          Schéma TestBd.ContextProfile.Profile
├── context_profile.ex      Contexte TestBd.ContextProfile
├── context_user
│   └── user.ex             Schéma TestBd.ContextUser.User
└── context_user.ex         Contexte TestBd.ContextUser


lib/test_bd_web/
├── controllers
│   ├── profile_controller.ex
│   └── user_controller.ex
├── templates
│   ├── profile
│   │   ├── edit.html.eex
│   │   ├── form.html.eex
│   │   ├── index.html.eex
│   │   ├── new.html.eex
│   │   └── show.html.eex
│   └── user
│       ├── edit.html.eex
│       ├── form.html.eex
│       ├── index.html.eex
│       ├── new.html.eex
│       └── show.html.eex
└── views
    ├── profile_view.ex
    └── user_view.ex
</code></pre>
<p>Par chaque contexte les fonctions générées par défaut correspondent à chaque action CRUD, par exemple pour le contexte <code>Profile</code>:</p>
<ul>
<li><code>list_profiles/0</code></li>
<li><code>get_profile/1</code></li>
<li><code>create_profile/1</code></li>
<li><code>update_profile/2</code></li>
<li><code>delete_profile/1</code></li>
</ul>
<p>Ajouter les ressources crées précédemment dans <code>lib/test_bd_web/router.ex</code>:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true"></a>scope <span class="st">&quot;/&quot;</span>, <span class="cn">TestBdWeb</span> <span class="kw">do</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true"></a>    pipe_through <span class="va">:browser</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true"></a>    get <span class="st">&quot;/&quot;</span>, <span class="cn">PageController</span>, <span class="va">:index</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true"></a>    resources <span class="st">&quot;/profiles&quot;</span>, <span class="cn">ProfileController</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true"></a>    resources <span class="st">&quot;/users&quot;</span>, <span class="cn">UserController</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true"></a><span class="kw">end</span></span></code></pre></div>
<p>Les routes/URL suivantes sont désormais disponibles pour interragir avec la base de données:</p>
<pre class="console"><code>mix phx.routes
Compiling 1 file (.ex)
          page_path  GET     /                                      TestBdWeb.PageController :index
       profile_path  GET     /profiles                              TestBdWeb.ProfileController :index
       profile_path  GET     /profiles/:id/edit                     TestBdWeb.ProfileController :edit
       profile_path  GET     /profiles/new                          TestBdWeb.ProfileController :new
       profile_path  GET     /profiles/:id                          TestBdWeb.ProfileController :show
       profile_path  POST    /profiles                              TestBdWeb.ProfileController :create
       profile_path  PATCH   /profiles/:id                          TestBdWeb.ProfileController :update
                     PUT     /profiles/:id                          TestBdWeb.ProfileController :update
       profile_path  DELETE  /profiles/:id                          TestBdWeb.ProfileController :delete
          user_path  GET     /users                                 TestBdWeb.UserController :index
          user_path  GET     /users/:id/edit                        TestBdWeb.UserController :edit
          user_path  GET     /users/new                             TestBdWeb.UserController :new
          user_path  GET     /users/:id                             TestBdWeb.UserController :show
          user_path  POST    /users                                 TestBdWeb.UserController :create
          user_path  PATCH   /users/:id                             TestBdWeb.UserController :update
                     PUT     /users/:id                             TestBdWeb.UserController :update
          user_path  DELETE  /users/:id                             TestBdWeb.UserController :delete
live_dashboard_path  GET     /dashboard                             Phoenix.LiveView.Plug :home
live_dashboard_path  GET     /dashboard/:node/:page                 Phoenix.LiveView.Plug :page
          websocket  WS      /live/websocket                        Phoenix.LiveView.Socket
           longpoll  GET     /live/longpoll                         Phoenix.LiveView.Socket
           longpoll  POST    /live/longpoll                         Phoenix.LiveView.Socket
          websocket  WS      /socket/websocket                      TestBdWeb.UserSocket</code></pre>
<p>Notons qu'il est possible d'exclure certains type de requêtes:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true"></a>scope <span class="st">&quot;/&quot;</span>, <span class="cn">TestBdWeb</span> <span class="kw">do</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true"></a>    pipe_through <span class="va">:browser</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true"></a>    get <span class="st">&quot;/&quot;</span>, <span class="cn">PageController</span>, <span class="va">:index</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true"></a>    resources <span class="st">&quot;/profiles&quot;</span>, <span class="cn">ProfileController</span>, <span class="va">only:</span> [<span class="va">:show</span>] <span class="co">#except: [:update]</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true"></a>    resources <span class="st">&quot;/users&quot;</span>, <span class="cn">UserController</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true"></a><span class="kw">end</span></span></code></pre></div>
<p>Également supprimer les références aux opérations rendues indisponibles dans les templates, par exemple supprimer <code>Routes.profile_path(@conn, :delete, profile)</code>.</p>
<h2 id="ajouter-la-sélection-du-type-de-profil-lors-de-la-création-dun-utilisateur"><a name="selecttype"></a>Ajouter la sélection du type de profil lors de la création d'un utilisateur</h2>
<p>Ne pas oublier de créer quelques profils <a href="http://localhost:4000/profiles">http://localhost:4000/profiles</a>. Le paramètre <code>:profile_id</code> doit être ajouté au changeset avec <code>:name</code> afin d'être conservé dans la table. Modifier <code>lib/test_bd/context_user/user.ex</code>:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true"></a><span class="kw">defmodule</span> <span class="cn">TestBd</span><span class="op">.</span><span class="cn">ContextUser</span><span class="op">.</span><span class="cn">User</span> <span class="kw">do</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true"></a>  <span class="im">use</span> <span class="cn">Ecto</span><span class="op">.</span><span class="cn">Schema</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true"></a>  <span class="im">import</span> <span class="cn">Ecto</span><span class="op">.</span><span class="cn">Changeset</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true"></a>  schema <span class="st">&quot;users&quot;</span> <span class="kw">do</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true"></a>    field <span class="va">:name</span>, <span class="va">:string</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true"></a>    field <span class="va">:profile_id</span>, <span class="va">:id</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true"></a></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true"></a>    timestamps()</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true"></a>  <span class="kw">end</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true"></a></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true"></a>  <span class="ot">@doc</span> <span class="cn">false</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true"></a>  <span class="kw">def</span> changeset(user, attrs) <span class="kw">do</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true"></a>    user</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true"></a>    <span class="co">#|&gt; cast(attrs, [:name])</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true"></a>    <span class="co">#|&gt; validate_required([:name])</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true"></a>    <span class="op">|&gt;</span> cast(attrs, [<span class="va">:name</span>, <span class="va">:profile_id</span>])</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true"></a>    <span class="op">|&gt;</span> validate_required([<span class="va">:name</span>, <span class="va">:profile_id</span>], <span class="va">message:</span> <span class="st">&quot;Champ obligatoire.&quot;</span>)</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true"></a>    <span class="op">|&gt;</span> validate_format(<span class="va">:name</span>, <span class="op">~</span>r<span class="op">/^</span>[a<span class="op">-</span>z]<span class="op">+</span>$<span class="op">/</span>, <span class="va">message:</span> <span class="st">&quot;Seules les lettres minuscules sont autorisées.&quot;</span>)</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true"></a>    <span class="op">|&gt;</span> unique_constraint(<span class="va">:name</span>, <span class="va">message:</span> <span class="st">&quot;Nom existe déjà&quot;</span>)</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true"></a>  <span class="kw">end</span></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true"></a><span class="kw">end</span></span></code></pre></div>
<p>Pour être en mesure d'avoir un paramètre <code>:profile</code>, il faut rendre sélectionnable ce paramètre dans le formulaire. Modifier le template <code>lib/test_bd_web/templates/user/form.html.eex</code>:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true"></a><span class="op">&lt;%=</span> form_for <span class="ot">@changeset</span>, <span class="ot">@action</span>, <span class="kw">fn</span> f <span class="op">-&gt;</span> %<span class="op">&gt;</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true"></a>  <span class="op">&lt;%=</span> <span class="cf">if</span> <span class="ot">@changeset</span><span class="op">.</span>action <span class="kw">do</span> %<span class="op">&gt;</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true"></a>    <span class="op">&lt;</span>div class<span class="op">=</span><span class="st">&quot;alert alert-danger&quot;</span><span class="op">&gt;</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true"></a>      <span class="op">&lt;</span>p<span class="op">&gt;</span><span class="cn">Oops</span>, something went wrong! <span class="cn">Please</span> check the errors below<span class="op">.&lt;/</span>p<span class="op">&gt;</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true"></a>    <span class="op">&lt;/</span>div<span class="op">&gt;</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true"></a>  <span class="op">&lt;</span>% <span class="kw">end</span> %<span class="op">&gt;</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true"></a></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true"></a>  <span class="op">&lt;%=</span> label f, <span class="va">:name</span> %<span class="op">&gt;</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true"></a>  <span class="op">&lt;%=</span> text_input f, <span class="va">:name</span> %<span class="op">&gt;</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true"></a>  <span class="op">&lt;%=</span> error_tag f, <span class="va">:name</span> %<span class="op">&gt;</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true"></a>  </span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true"></a>  <span class="op">&lt;</span>!<span class="op">--</span> <span class="cn">Ajout</span> du select ici, <span class="ot">@profiles</span> sera définie dans lib<span class="op">/</span>test_bd_web<span class="op">/</span>controllers<span class="op">/</span>user_controller<span class="op">.</span>ex</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true"></a>  <span class="cn">En</span> utilisant la fonction <span class="cn">TestBd</span><span class="op">.</span><span class="cn">ContextProfile</span><span class="op">.</span>list_profiles (lib<span class="op">/</span>test_bd<span class="op">/</span>context_profile<span class="op">.</span>ex) <span class="op">--&gt;</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true"></a>  <span class="op">&lt;%=</span> label f, <span class="va">:profile_id</span> %<span class="op">&gt;</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true"></a>  <span class="op">&lt;%=</span> select f, <span class="va">:profile_id</span>, <span class="cn">Enum</span><span class="op">.</span>map(<span class="ot">@profiles</span>, <span class="op">&amp;</span>{<span class="op">&amp;</span><span class="dv">1</span><span class="op">.</span>profile, <span class="op">&amp;</span><span class="dv">1</span><span class="op">.</span>id}) %<span class="op">&gt;</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true"></a>  <span class="op">&lt;%=</span> error_tag f, <span class="va">:profile_id</span> %<span class="op">&gt;</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true"></a></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true"></a>  <span class="op">&lt;</span>div<span class="op">&gt;</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true"></a>    <span class="op">&lt;%=</span> submit <span class="st">&quot;Save&quot;</span> %<span class="op">&gt;</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true"></a>  <span class="op">&lt;/</span>div<span class="op">&gt;</span></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true"></a><span class="op">&lt;</span>% <span class="kw">end</span> %<span class="op">&gt;</span></span></code></pre></div>
<p>Il faut transmettre <code>@profiles</code> aux templates <code>edit.html</code> et <code>new.html</code> devant permettre la sélection du paramètre <code>:profile</code>. Modifier le controleur <code>lib/test_bd_web/controllers/user_controller.ex</code>:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true"></a>  <span class="kw">def</span> new(conn, _params) <span class="kw">do</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true"></a>    changeset <span class="op">=</span> <span class="cn">ContextUser</span><span class="op">.</span>change_user(%<span class="cn">User</span>{})</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true"></a>    </span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true"></a>    <span class="co">#Définition de @profiles en utilisant TestBd.ContextProfile.list_profiles (lib/test_bd/context_profile.ex)</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true"></a>    profiles <span class="op">=</span> <span class="cn">TestBd</span><span class="op">.</span><span class="cn">ContextProfile</span><span class="op">.</span>list_profiles</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true"></a>    render(conn, <span class="st">&quot;new.html&quot;</span>, <span class="va">changeset:</span> changeset, <span class="va">profiles:</span> profiles)</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true"></a>  <span class="kw">end</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true"></a></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true"></a>  <span class="kw">def</span> edit(conn, %{<span class="st">&quot;id&quot;</span> <span class="op">=&gt;</span> id}) <span class="kw">do</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true"></a>    user <span class="op">=</span> <span class="cn">ContextUser</span><span class="op">.</span>get_user!(id)</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true"></a>    changeset <span class="op">=</span> <span class="cn">ContextUser</span><span class="op">.</span>change_user(user)</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true"></a></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true"></a>    <span class="co">#Définition de @profiles en utilisant TestBd.ContextProfile.list_profiles (lib/test_bd/context_profile.ex)</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true"></a>    profiles <span class="op">=</span> <span class="cn">TestBd</span><span class="op">.</span><span class="cn">ContextProfile</span><span class="op">.</span>list_profiles</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true"></a>    render(conn, <span class="st">&quot;edit.html&quot;</span>, <span class="va">user:</span> user, <span class="va">changeset:</span> changeset, <span class="va">profiles:</span> profiles)</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true"></a>  <span class="kw">end</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true"></a>  </span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true"></a>  <span class="kw">def</span> create(conn, %{<span class="st">&quot;user&quot;</span> <span class="op">=&gt;</span> user_params}) <span class="kw">do</span></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true"></a>    <span class="kw">case</span> <span class="cn">ContextUser</span><span class="op">.</span>create_user(user_params) <span class="kw">do</span></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true"></a>      {<span class="va">:ok</span>, user} <span class="op">-&gt;</span></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true"></a>        conn</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true"></a>        <span class="op">|&gt;</span> put_flash(<span class="va">:info</span>, <span class="st">&quot;User created successfully.&quot;</span>)</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true"></a>        <span class="op">|&gt;</span> redirect(<span class="va">to:</span> <span class="cn">Routes</span><span class="op">.</span>user_path(conn, <span class="va">:show</span>, user))</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true"></a></span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true"></a>      {<span class="va">:error</span>, %<span class="cn">Ecto</span><span class="op">.</span><span class="cn">Changeset</span>{} <span class="op">=</span> changeset} <span class="op">-&gt;</span></span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true"></a>        <span class="co">#Définition de @profiles en utilisant TestBd.ContextProfile.list_profiles (lib/test_bd/context_profile.ex)</span></span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true"></a>        profiles <span class="op">=</span> <span class="cn">TestBd</span><span class="op">.</span><span class="cn">ContextProfile</span><span class="op">.</span>list_profiles</span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true"></a>        render(conn, <span class="st">&quot;new.html&quot;</span>, <span class="va">changeset:</span> changeset, <span class="va">profiles:</span> profiles)</span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true"></a>    <span class="kw">end</span></span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true"></a>  <span class="kw">end</span></span></code></pre></div>
<h2 id="ajuster-les-relations-pour-afficher-le-nom-du-profil-au-lieu-de-son-id"><a name="relation"></a>Ajuster les relations pour afficher le nom du profil au lieu de son ID</h2>
<p>Par défaut <code>list_users/0</code> du contexte <em>ContextUser</em> <code>lib/test_bd/context_user.ex</code> retourne seulement le contenu de la table <code>users</code> (colonnes <em>name</em> et <em>profile_id</em>). Pour afficher le type de profile au lieu de son ID (<em>profile_id</em>), il faut retourner la colonne <em>profile</em> de la table <code>profiles</code> après une jointure entre les tables <code>users</code> et <code>profiles</code>.</p>
<p>Commençons par ajouter les relations dans les schémas Ecto: un utilisateur possède un seul profil et un profil est possédé par un ou plusieurs utilisateurs. Modifier le schéma <code>lib/test_bd/context_user/user.ex</code>:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true"></a>schema <span class="st">&quot;users&quot;</span> <span class="kw">do</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true"></a>    field <span class="va">:name</span>, <span class="va">:string</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true"></a>    <span class="co">#field :profile_id, :id</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true"></a>    <span class="co">#Relation 1 utilisateur possède 1 profile</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true"></a>    belongs_to <span class="va">:profile</span>, <span class="cn">TestBd</span><span class="op">.</span><span class="cn">ContextProfile</span><span class="op">.</span><span class="cn">Profile</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true"></a></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true"></a>    timestamps()</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true"></a><span class="kw">end</span></span></code></pre></div>
<p>Modifier le schéma <code>lib/test_bd/context_user/profile.ex</code>:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true"></a>schema <span class="st">&quot;profiles&quot;</span> <span class="kw">do</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true"></a>    field <span class="va">:profile</span>, <span class="va">:string</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true"></a></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true"></a>    <span class="co">#Relation 1 profil est possédé par plusieurs utilisateurs</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true"></a>    has_many <span class="va">:user</span>, <span class="cn">TestBd</span><span class="op">.</span><span class="cn">ContextUser</span><span class="op">.</span><span class="cn">User</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true"></a></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true"></a>    timestamps()</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true"></a><span class="kw">end</span></span></code></pre></div>
<p>Nous pouvons maintenant utliser le Preloader Ecto pour effectuer la jointure entre la table <code>users</code> et <code>profiles</code> (toutes les colonnes des deux tables seront retournées).</p>
<p>La solution la plus convenable est d'écrire deux nouvelles fonctions dans le contexte ContextUser <code>lib/test_bd/context_user.ex</code> Les fonctions <code>list_users/0</code> et <code>get_user/1</code> déjà existantes peuvent servir de base pour ces fonctions.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true"></a><span class="kw">def</span> list_users_with_profile <span class="kw">do</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true"></a>    <span class="cn">User</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true"></a>    <span class="op">|&gt;</span> <span class="cn">Repo</span><span class="op">.</span>all()</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true"></a>    <span class="op">|&gt;</span> <span class="cn">Repo</span><span class="op">.</span>preload(<span class="va">:profile</span>)</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true"></a><span class="kw">end</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true"></a></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true"></a><span class="kw">def</span> get_user_with_profile!(id) <span class="kw">do</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true"></a>    <span class="cn">User</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true"></a>    <span class="op">|&gt;</span> <span class="cn">Repo</span><span class="op">.</span>get!(id)</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true"></a>    <span class="op">|&gt;</span> <span class="cn">Repo</span><span class="op">.</span>preload(<span class="va">:profile</span>)</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true"></a><span class="kw">end</span></span></code></pre></div>
<p>Utiliser nos fonctions dans le controleur User <code>lib/test_bd_web/controllers/user_controller.ex</code> afin de passer les données aux templates <code>index</code> et <code>show</code>:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true"></a><span class="kw">def</span> index(conn, _params) <span class="kw">do</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true"></a>    users <span class="op">=</span> list_users_with_profile</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true"></a>    render(conn, <span class="st">&quot;index.html&quot;</span>, <span class="va">users:</span> users)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true"></a><span class="kw">end</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true"></a></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true"></a><span class="kw">def</span> show(conn, %{<span class="st">&quot;id&quot;</span> <span class="op">=&gt;</span> id}) <span class="kw">do</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true"></a>    user <span class="op">=</span> <span class="cn">ContextUser</span><span class="op">.</span>get_user_with_profile!(id)</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true"></a>    render(conn, <span class="st">&quot;show.html&quot;</span>, <span class="va">user:</span> user)</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true"></a><span class="kw">end</span></span></code></pre></div>
<p>Pour afficher la colonne profile, modifier le template <code>lib/test_bd_web/templates/user/index.html.eex</code>:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true"></a><span class="op">&lt;</span>h1<span class="op">&gt;</span><span class="cn">Listing</span> <span class="cn">Users</span><span class="op">&lt;/</span>h1<span class="op">&gt;</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true"></a></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true"></a><span class="op">&lt;</span>table<span class="op">&gt;</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true"></a>  <span class="op">&lt;</span>thead<span class="op">&gt;</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true"></a>    <span class="op">&lt;</span>tr<span class="op">&gt;</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true"></a>      <span class="op">&lt;</span>th<span class="op">&gt;</span><span class="cn">Name</span><span class="op">&lt;/</span>th<span class="op">&gt;</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true"></a>      <span class="op">&lt;</span>th<span class="op">&gt;</span><span class="cn">Profile</span><span class="op">&lt;/</span>th<span class="op">&gt;</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true"></a></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true"></a>      <span class="op">&lt;</span>th<span class="op">&gt;&lt;/</span>th<span class="op">&gt;</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true"></a>    <span class="op">&lt;/</span>tr<span class="op">&gt;</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true"></a>  <span class="op">&lt;/</span>thead<span class="op">&gt;</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true"></a>  <span class="op">&lt;</span>tbody<span class="op">&gt;</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true"></a></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true"></a>  <span class="op">&lt;%=</span> <span class="kw">for</span> user <span class="op">&lt;-</span> <span class="ot">@users</span> <span class="kw">do</span> %<span class="op">&gt;</span></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true"></a>    <span class="op">&lt;</span>tr<span class="op">&gt;</span></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true"></a>      <span class="op">&lt;</span>td<span class="op">&gt;&lt;%=</span> user<span class="op">.</span>name %<span class="op">&gt;&lt;/</span>td<span class="op">&gt;</span></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true"></a>      <span class="op">&lt;</span>td<span class="op">&gt;&lt;%=</span> user<span class="op">.</span>profile<span class="op">.</span>profile %<span class="op">&gt;&lt;/</span>td<span class="op">&gt;</span></span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true"></a>      <span class="op">&lt;</span>td<span class="op">&gt;</span></span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true"></a>        <span class="op">&lt;</span>span<span class="op">&gt;&lt;%=</span> link <span class="st">&quot;Show&quot;</span>, <span class="va">to:</span> <span class="cn">Routes</span><span class="op">.</span>user_path(<span class="ot">@conn</span>, <span class="va">:show</span>, user) %<span class="op">&gt;&lt;/</span>span<span class="op">&gt;</span></span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true"></a>        <span class="op">&lt;</span>span<span class="op">&gt;&lt;%=</span> link <span class="st">&quot;Edit&quot;</span>, <span class="va">to:</span> <span class="cn">Routes</span><span class="op">.</span>user_path(<span class="ot">@conn</span>, <span class="va">:edit</span>, user) %<span class="op">&gt;&lt;/</span>span<span class="op">&gt;</span></span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true"></a>        <span class="op">&lt;</span>span<span class="op">&gt;&lt;%=</span> link <span class="st">&quot;Delete&quot;</span>, <span class="va">to:</span> <span class="cn">Routes</span><span class="op">.</span>user_path(<span class="ot">@conn</span>, <span class="va">:delete</span>, user), <span class="va">method:</span> <span class="va">:delete</span>, <span class="va">data:</span> [<span class="va">confirm:</span> <span class="st">&quot;Are you sure?&quot;</span>] %<span class="op">&gt;&lt;/</span>span<span class="op">&gt;</span></span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true"></a>      <span class="op">&lt;/</span>td<span class="op">&gt;</span></span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true"></a>    <span class="op">&lt;/</span>tr<span class="op">&gt;</span></span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true"></a>  <span class="op">&lt;</span>% <span class="kw">end</span> %<span class="op">&gt;</span></span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true"></a>  <span class="op">&lt;/</span>tbody<span class="op">&gt;</span></span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true"></a><span class="op">&lt;/</span>table<span class="op">&gt;</span></span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true"></a></span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true"></a><span class="op">&lt;</span>span<span class="op">&gt;&lt;%=</span> link <span class="st">&quot;New User&quot;</span>, <span class="va">to:</span> <span class="cn">Routes</span><span class="op">.</span>user_path(<span class="ot">@conn</span>, <span class="va">:new</span>) %<span class="op">&gt;&lt;/</span>span<span class="op">&gt;</span></span></code></pre></div>
<p>Ainsi que le template <code>lib/test_bd_web/templates/user/show.html.eex</code>:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true"></a><span class="op">&lt;</span>h1<span class="op">&gt;</span><span class="cn">Show</span> <span class="cn">User</span><span class="op">&lt;/</span>h1<span class="op">&gt;</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true"></a></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true"></a><span class="op">&lt;</span>ul<span class="op">&gt;</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true"></a>  <span class="op">&lt;</span>li<span class="op">&gt;</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true"></a>    <span class="op">&lt;</span>strong<span class="op">&gt;</span><span class="cn">Name</span>:<span class="op">&lt;/</span>strong<span class="op">&gt;</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true"></a>    <span class="op">&lt;%=</span> <span class="ot">@user</span><span class="op">.</span>name %<span class="op">&gt;</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true"></a>  <span class="op">&lt;/</span>li<span class="op">&gt;</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true"></a>  <span class="op">&lt;</span>li<span class="op">&gt;</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true"></a>    <span class="op">&lt;</span>strong<span class="op">&gt;</span><span class="cn">Profile</span>:<span class="op">&lt;/</span>strong<span class="op">&gt;</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true"></a>    <span class="op">&lt;%=</span> <span class="ot">@user</span><span class="op">.</span>profile<span class="op">.</span>profile %<span class="op">&gt;</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true"></a>  <span class="op">&lt;/</span>li<span class="op">&gt;</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true"></a><span class="op">&lt;/</span>ul<span class="op">&gt;</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true"></a></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true"></a><span class="op">&lt;</span>span<span class="op">&gt;&lt;%=</span> link <span class="st">&quot;Edit&quot;</span>, <span class="va">to:</span> <span class="cn">Routes</span><span class="op">.</span>user_path(<span class="ot">@conn</span>, <span class="va">:edit</span>, <span class="ot">@user</span>) %<span class="op">&gt;&lt;/</span>span<span class="op">&gt;</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true"></a><span class="op">&lt;</span>span<span class="op">&gt;&lt;%=</span> link <span class="st">&quot;Back&quot;</span>, <span class="va">to:</span> <span class="cn">Routes</span><span class="op">.</span>user_path(<span class="ot">@conn</span>, <span class="va">:index</span>) %<span class="op">&gt;&lt;/</span>span<span class="op">&gt;</span></span></code></pre></div>
<h2 id="ajouter-un-filtre-sur-le-type-de-profil">Ajouter un filtre sur le type de profil</h2>
<p>Passer la listes des profils au template <code>lib/test_bd_web/templates/user/index.html.eex</code> depuis le controleur <code>lib/test_bd_web/controllers/user_controller.ex</code> dans la fonction <code>index/2</code>:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true"></a><span class="kw">def</span> index(conn, params) <span class="kw">do</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true"></a>    users <span class="op">=</span> <span class="kw">case</span> <span class="cn">Map</span><span class="op">.</span>fetch(params, <span class="st">&quot;profile&quot;</span>) <span class="kw">do</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true"></a>        {<span class="va">:ok</span>, <span class="st">&quot;&quot;</span>} <span class="op">-&gt;</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true"></a>            <span class="cn">ContextUser</span><span class="op">.</span>list_users_with_profile</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true"></a>        {<span class="va">:ok</span>, user_type_filter} <span class="op">-&gt;</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true"></a>            <span class="cn">ContextUser</span><span class="op">.</span>list_users_with_profile(user_type_filter)</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true"></a>        <span class="va">:error</span> <span class="op">-&gt;</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true"></a>            <span class="cn">ContextUser</span><span class="op">.</span>list_users_with_profile</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true"></a>    <span class="kw">end</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true"></a></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true"></a>  profiles <span class="op">=</span> <span class="cn">TestBd</span><span class="op">.</span><span class="cn">ContextProfile</span><span class="op">.</span>list_profiles</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true"></a>  render(conn, <span class="st">&quot;index.html&quot;</span>, <span class="va">users:</span> users, <span class="va">profiles:</span> profiles)</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true"></a><span class="kw">end</span></span></code></pre></div>
<p>Ajouter un formulaire avec un menu déroulant <code>select</code> dans le template <code>lib/test_bd_web/templates/user/index.html.eex</code> qui va recevoir la liste des profils <code>@profiles</code> et transmettre au controleur <code>params</code> via une requête GET:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true"></a><span class="op">&lt;%=</span> form_for <span class="ot">@conn</span>, <span class="cn">Routes</span><span class="op">.</span>user_path(<span class="ot">@conn</span>, <span class="va">:index</span>), [<span class="va">method:</span> <span class="va">:get</span>], <span class="kw">fn</span> f <span class="op">-&gt;</span> %<span class="op">&gt;</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true"></a>  <span class="op">&lt;%=</span> select f, <span class="va">:profile</span>, <span class="cn">Enum</span><span class="op">.</span>map(<span class="ot">@profiles</span>, <span class="op">&amp;</span>{<span class="op">&amp;</span><span class="dv">1</span><span class="op">.</span>profile, <span class="op">&amp;</span><span class="dv">1</span><span class="op">.</span>profile}), <span class="va">prompt:</span> <span class="st">&quot;Filtrer par profil&quot;</span>, <span class="va">onchange:</span> <span class="st">&quot;this.form.submit();&quot;</span>, <span class="va">class:</span> <span class="st">&quot;form-control&quot;</span> %<span class="op">&gt;</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true"></a><span class="op">&lt;</span>% <span class="kw">end</span> %<span class="op">&gt;</span></span></code></pre></div>
<p>Ajouter une fonction <code>list_users_with_profile/1</code> chargée de récupérer les données dans le contexte ContextUser <code>/test_bd/context_user.ex</code>:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true"></a><span class="kw">def</span> list_users_with_profile(profile) <span class="kw">do</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true"></a>    <span class="cn">User</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true"></a>    <span class="op">|&gt;</span> join(<span class="va">:inner</span>, [u], p <span class="kw">in</span> <span class="cn">TestBd</span><span class="op">.</span><span class="cn">ContextProfile</span><span class="op">.</span><span class="cn">Profile</span>, <span class="va">on:</span> u<span class="op">.</span>profile_id <span class="op">==</span> p<span class="op">.</span>id)</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true"></a>    <span class="op">|&gt;</span> where([u, p], p<span class="op">.</span>profile <span class="op">==</span> <span class="op">^</span>profile)</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true"></a>    <span class="op">|&gt;</span> select([u, p], %<span class="cn">User</span>{<span class="va">id:</span> u<span class="op">.</span>id, <span class="va">name:</span> u<span class="op">.</span>name, <span class="va">profile:</span> %{<span class="va">profile:</span> p<span class="op">.</span>profile, <span class="va">profile_id:</span> p<span class="op">.</span>id}})</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true"></a>    <span class="op">|&gt;</span> order_by([u], [<span class="va">asc:</span> u<span class="op">.</span>name])</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true"></a>    <span class="op">|&gt;</span> <span class="cn">Repo</span><span class="op">.</span>all()</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true"></a><span class="kw">end</span></span></code></pre></div>
<p>Nous effectuons le filtre depuis les types de profil mais leurs ID auraient pu être utilisés. L'opérateur <code>^</code> sert à l'interpolation de la variable <code>profile</code>. Plusieurs variantes de la même requête sont possibles avec Ecto:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true"></a><span class="co">#Avec Preload</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true"></a>query <span class="op">=</span> from u <span class="kw">in</span> <span class="cn">User</span>,</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true"></a>        <span class="va">join:</span> p <span class="kw">in</span> <span class="cn">TestBd</span><span class="op">.</span><span class="cn">ContextProfile</span><span class="op">.</span><span class="cn">Profile</span>, <span class="va">on:</span> u<span class="op">.</span>profile_id <span class="op">==</span> p<span class="op">.</span>id,</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true"></a>        <span class="va">where:</span> p<span class="op">.</span>profile <span class="op">==</span> <span class="op">^</span>profile,</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true"></a>        <span class="va">preload:</span> [<span class="va">profile:</span> p],</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true"></a>        <span class="va">order_by:</span> [<span class="va">asc:</span> <span class="va">:name</span>]</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true"></a></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true"></a><span class="co">#Avec Preload</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true"></a>query <span class="op">=</span> from u <span class="kw">in</span> <span class="cn">User</span>,</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true"></a>        <span class="va">join:</span> p <span class="kw">in</span> assoc(u, <span class="va">:profile</span>),</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true"></a>        <span class="va">where:</span> p<span class="op">.</span>profile <span class="op">==</span> <span class="op">^</span>profile,</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true"></a>        <span class="va">preload:</span> [<span class="va">profile:</span> p],</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true"></a>        <span class="va">order_by:</span> [<span class="va">asc:</span> <span class="va">:name</span>]</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true"></a></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true"></a><span class="co">#Sans Preload</span></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true"></a>query <span class="op">=</span> from u <span class="kw">in</span> <span class="cn">User</span>,</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true"></a>        <span class="va">join:</span> p <span class="kw">in</span> <span class="cn">TestBd</span><span class="op">.</span><span class="cn">ContextProfile</span><span class="op">.</span><span class="cn">Profile</span>, <span class="va">on:</span> u<span class="op">.</span>profile_id <span class="op">==</span> p<span class="op">.</span>id,</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true"></a>        <span class="va">where:</span> p<span class="op">.</span>profile <span class="op">==</span> <span class="op">^</span>profile,</span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true"></a>        <span class="va">order_by:</span> [<span class="va">asc:</span> <span class="va">:name</span>],</span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true"></a>        select([u, p], %<span class="cn">User</span>{<span class="va">id:</span> u<span class="op">.</span>id, <span class="va">name:</span> u<span class="op">.</span>name, <span class="va">profile:</span> %{<span class="va">profile:</span> p<span class="op">.</span>profile, <span class="va">profile_id:</span> p<span class="op">.</span>id}})</span></code></pre></div>
<h2 id="liens-complémentaires">Liens complémentaires</h2>
<ul>
<li><a href="https://hexdocs.pm/phoenix/Mix.Tasks.Phx.Gen.Schema.html">https://hexdocs.pm/phoenix/Mix.Tasks.Phx.Gen.Schema.html</a></li>
<li><a href="https://hexdocs.pm/phoenix/Mix.Tasks.Phx.Gen.Html.html">https://hexdocs.pm/phoenix/Mix.Tasks.Phx.Gen.Html.html</a></li>
<li><a href="https://hexdocs.pm/ecto/Ecto.Changeset.html">https://hexdocs.pm/ecto/Ecto.Changeset.html</a></li>
<li><a href="https://hexdocs.pm/ecto/Ecto.Query.html">https://hexdocs.pm/ecto/Ecto.Query.html</a></li>
<li><a href="https://hexdocs.pm/ecto/2.2.11/associations.html#one-to-one">https://hexdocs.pm/ecto/2.2.11/associations.html#one-to-one</a></li>
<li><a href="https://hexdocs.pm/phoenix/contexts.html">https://hexdocs.pm/phoenix/contexts.html</a></li>
<li><a href="https://hexdocs.pm/ecto/Ecto.Repo.html#c:preload/3">https://hexdocs.pm/ecto/Ecto.Repo.html#c:preload/3</a></li>
<li><a href="https://dueacaso.it/tech/crud_app_with_phoenix/">https://dueacaso.it/tech/crud_app_with_phoenix/</a></li>
<li><a href="https://whatdidilearn.info/2018/02/04/implementing-crud-in-phoenix.html">https://whatdidilearn.info/2018/02/04/implementing-crud-in-phoenix.html</a></li>
<li><a href="https://michael.minton.io/2018/12/creating-a-form-for-a-non-persisted-ecto-schema-in-phoenix.html">https://michael.minton.io/2018/12/creating-a-form-for-a-non-persisted-ecto-schema-in-phoenix.html</a></li>
<li><a href="https://www.alanvardy.com/post/associations-phoenix">https://www.alanvardy.com/post/associations-phoenix</a></li>
<li><a href="https://www.sitepoint.com/understanding-elixirs-ecto-querying-dsl-the-basics/">https://www.sitepoint.com/understanding-elixirs-ecto-querying-dsl-the-basics/</a></li>
<li><a href="https://blog.appsignal.com/2020/11/10/understanding-associations-in-elixir-ecto.html">https://blog.appsignal.com/2020/11/10/understanding-associations-in-elixir-ecto.html</a></li>
</ul>
</article>

<div id="footer">
  <span class="copyrights">© 2015-2021 C. Boyer, contenu sous licence <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.fr">Creative Commons BY-SA-NC 4.0</a>, l'ensemble des codes sources sont sous licence <a href="https://www.gnu.org/licenses/gpl-3.0.fr.html">GNU GPL v3</a>.</span>
</div>

</div>
</body>
</html>
