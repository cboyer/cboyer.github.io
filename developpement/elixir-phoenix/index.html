<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="HandheldFriendly" content="True">
  <title>Elixir et framework Phoenix: page simple - C. Boyer</title>
  <meta name="description" content="Le web avec Elixir et son framework Phoenix." />
  <meta name="author" content="C. Boyer" />
  <meta name="keywords" content="Elixir, Phoenix, Liveview, mix, iex" />
  <link rel="canonical" href="https://cboyer.github.io/developpement/elixir-phoenix" />
  <meta property="og:title" content="Elixir et framework Phoenix: page simple - C. Boyer" />
  <meta property="og:locale" content="fr_CA" />
  <meta property="og:description" content="Le web avec Elixir et son framework Phoenix." />
  <meta property="og:site_name" content="cboyer.github.io" />
  <meta property="og:type" content="website" />
  <meta property="og:updated_time" content="2020-10-28T17:13:11-04:00" />
  <meta property="article:published_time" content="2020-10-28T17:13:11-04:00" />
  <meta property="article:modified_time" content="2020-10-28T17:13:11-04:00" />
  <meta name="robots" content="index,follow">
  <link rel="icon" href="data:;base64,iVBORw0KGgo=">
  <link href="https://cboyer.github.io/atom.xml" rel="alternate" type="application/atom+xml" />
  <link rel="stylesheet" type="text/css" href="../../style.css" />
  <style>
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    background-color: #ffffff;
    color: #a0a0a0;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #a0a0a0;  padding-left: 4px; }
div.sourceCode
  { color: #1f1c1b; background-color: #ffffff; }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span { color: #1f1c1b; } /* Normal */
code span.al { color: #bf0303; background-color: #f7e6e6; font-weight: bold; } /* Alert */
code span.an { color: #ca60ca; } /* Annotation */
code span.at { color: #0057ae; } /* Attribute */
code span.bn { color: #b08000; } /* BaseN */
code span.bu { color: #644a9b; font-weight: bold; } /* BuiltIn */
code span.cf { color: #1f1c1b; font-weight: bold; } /* ControlFlow */
code span.ch { color: #924c9d; } /* Char */
code span.cn { color: #aa5500; } /* Constant */
code span.co { color: #898887; } /* Comment */
code span.cv { color: #0095ff; } /* CommentVar */
code span.do { color: #607880; } /* Documentation */
code span.dt { color: #0057ae; } /* DataType */
code span.dv { color: #b08000; } /* DecVal */
code span.er { color: #bf0303; text-decoration: underline; } /* Error */
code span.ex { color: #0095ff; font-weight: bold; } /* Extension */
code span.fl { color: #b08000; } /* Float */
code span.fu { color: #644a9b; } /* Function */
code span.im { color: #ff5500; } /* Import */
code span.in { color: #b08000; } /* Information */
code span.kw { color: #1f1c1b; font-weight: bold; } /* Keyword */
code span.op { color: #1f1c1b; } /* Operator */
code span.ot { color: #006e28; } /* Other */
code span.pp { color: #006e28; } /* Preprocessor */
code span.re { color: #0057ae; background-color: #e0e9f8; } /* RegionMarker */
code span.sc { color: #3daee9; } /* SpecialChar */
code span.ss { color: #ff5500; } /* SpecialString */
code span.st { color: #bf0303; } /* String */
code span.va { color: #0057ae; } /* Variable */
code span.vs { color: #bf0303; } /* VerbatimString */
code span.wa { color: #bf0303; } /* Warning */
  </style>
</head>
<body>
  <header id="header">
    <div id="links">
      <a href="https://github.com/cboyer" class="github" title="GitHub" target="_blank">
          <svg class="button" aria-labelledby="github-icon" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <title id="github-icon">GitHub</title>
            <path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"></path>
          </svg>
      </a>
      <a href="../../atom.xml" class="rss" title="Flux Atom">
          <svg class="button" aria-labelledby="atom-icon" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <title id="atom-icon">Flux Atom</title>
            <path d="M19.199 24C19.199 13.467 10.533 4.8 0 4.8V0c13.165 0 24 10.835 24 24h-4.801zM3.291 17.415c1.814 0 3.293 1.479 3.293 3.295 0 1.813-1.485 3.29-3.301 3.29C1.47 24 0 22.526 0 20.71s1.475-3.294 3.291-3.295zM15.909 24h-4.665c0-6.169-5.075-11.245-11.244-11.245V8.09c8.727 0 15.909 7.184 15.909 15.91z"></path>
          </svg>
      </a>
    </div>
    <p class="title">cboyer.github.io</p>
    <nav id="menu">
      <a href="../../index.html">Index</a> | <a href="../../developpement.html">Développement</a> | <a href="../../linux.html">Linux</a> | <a href="../../electronique.html">Électronique</a>
    </nav>
  </header>

  <main id="container">
<article>
<header id="title-block-header">
<h1>Elixir et framework Phoenix: page simple</h1>
 <small class="date">Publié le 2020-10-28</small>
</header>
<ul>
<li><a href="#installation">Installation de Phoenix</a></li>
<li><a href="#projetsimple">Création d'un projet Phoenix élémentaire</a></li>
<li><a href="#pagetest">Création d'une page "Test"</a></li>
<li><a href="#parametre">Passer un paramètre</a></li>
<li><a href="#liveview">LiveView: actualiser les éléments d'une page sans la refaraîchir</a></li>
<li><a href="#pubsub">LiveView et PubSub: communication entre differents clients</a></li>
</ul>
<h2 id="installation-de-phoenix"><a name="installation"></a>Installation de Phoenix</h2>
<pre class="console"><code>mix archive.install hex phx_new 1.5.4

Resolving Hex dependencies...
Dependency resolution completed:
New:
  phx_new 1.5.4
* Getting phx_new (Hex package)
All dependencies are up to date
Compiling 10 files (.ex)
Generated phx_new app
Generated archive &quot;phx_new-1.5.4.ez&quot; with MIX_ENV=prod
Are you sure you want to install &quot;phx_new-1.5.4.ez&quot;? [Yn] y
* creating /home/user/.mix/archives/phx_new-1.5.4</code></pre>
<p>Dépendances systèmes à installer: <code>inotify-tools</code> permet de bénéficier de la fonctionalité live-reload de Phoenix. <code>erlang-parsetools</code> pour compiler l'application (lié à gettext).</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true"></a><span class="fu">sudo</span> dnf install erlang-parsetools inotify-tools</span></code></pre></div>
<h2 id="création-dun-projet-phoenix-élémentaire"><a name="projetsimple"></a>Création d'un projet Phoenix élémentaire</h2>
<p>Pour créer un nouveau projet Phoenix minimaliste sans base de données (Ecto) ni NodeJS (Webpack):</p>
<pre class="console"><code>mix phx.new test_phoenix --no-webpack --no-ecto

* creating test_phoenix/config/config.exs
* creating test_phoenix/config/dev.exs
* creating test_phoenix/config/prod.exs
* creating test_phoenix/config/prod.secret.exs
* creating test_phoenix/config/test.exs
* creating test_phoenix/lib/test_phoenix/application.ex
* creating test_phoenix/lib/test_phoenix.ex
* creating test_phoenix/lib/test_phoenix_web/channels/user_socket.ex
* creating test_phoenix/lib/test_phoenix_web/views/error_helpers.ex
* creating test_phoenix/lib/test_phoenix_web/views/error_view.ex
* creating test_phoenix/lib/test_phoenix_web/endpoint.ex
* creating test_phoenix/lib/test_phoenix_web/router.ex
* creating test_phoenix/lib/test_phoenix_web/telemetry.ex
* creating test_phoenix/lib/test_phoenix_web.ex
* creating test_phoenix/mix.exs
* creating test_phoenix/README.md
* creating test_phoenix/.formatter.exs
* creating test_phoenix/.gitignore
* creating test_phoenix/test/support/channel_case.ex
* creating test_phoenix/test/support/conn_case.ex
* creating test_phoenix/test/test_helper.exs
* creating test_phoenix/test/test_phoenix_web/views/error_view_test.exs
* creating test_phoenix/lib/test_phoenix_web/controllers/page_controller.ex
* creating test_phoenix/lib/test_phoenix_web/templates/layout/app.html.eex
* creating test_phoenix/lib/test_phoenix_web/templates/page/index.html.eex
* creating test_phoenix/lib/test_phoenix_web/views/layout_view.ex
* creating test_phoenix/lib/test_phoenix_web/views/page_view.ex
* creating test_phoenix/test/test_phoenix_web/controllers/page_controller_test.exs
* creating test_phoenix/test/test_phoenix_web/views/layout_view_test.exs
* creating test_phoenix/test/test_phoenix_web/views/page_view_test.exs
* creating test_phoenix/lib/test_phoenix_web/gettext.ex
* creating test_phoenix/priv/gettext/en/LC_MESSAGES/errors.po
* creating test_phoenix/priv/gettext/errors.pot
* creating test_phoenix/priv/static/js/app.js
* creating test_phoenix/priv/static/css/app.css
* creating test_phoenix/priv/static/css/phoenix.css
* creating test_phoenix/priv/static/robots.txt
* creating test_phoenix/priv/static/js/phoenix.js
* creating test_phoenix/priv/static/images/phoenix.png
* creating test_phoenix/priv/static/favicon.ico

Fetch and install dependencies? [Yn] y
* running mix deps.get

We are almost there! The following steps are missing:
    $ cd test_phoenix

Start your Phoenix app with:
    $ mix phx.server

You can also run your app inside IEx (Interactive Elixir) as:
    $ iex -S mix phx.server</code></pre>
<h2 id="création-dune-page-test"><a name="pagetest"></a>Création d'une page "Test"</h2>
<p>Organisation des éléments d'une page "Test" (la partie modèle est volontairement omise car nous n'utilisons pas de base de données):</p>
<pre class="text"><code>Routeur        🠞 lib/test_phoenix_web/router.ex                      🠞 get &quot;/test&quot;, TestController, :index
|&gt; Controleur  🠞 lib/test_phoenix_web/controllers/test_controller.ex 🠞 TestPhoenixWeb.TestController
|&gt; Vue         🠞 lib/test_phoenix_web/views/test_view.ex             🠞 TestPhoenixWeb.TestView
|&gt; Template    🠞 lib/test_phoenix_web/templates/test/test.html.eex</code></pre>
<p>Ajouter une nouvelle route dans <code>lib/test_phoenix_web/router.ex</code>:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true"></a><span class="kw">defmodule</span> <span class="cn">TestPhoenixWeb</span><span class="op">.</span><span class="cn">Router</span> <span class="kw">do</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true"></a>    <span class="im">use</span> <span class="cn">TestPhoenixWeb</span>, <span class="va">:router</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true"></a>    pipeline <span class="va">:browser</span> <span class="kw">do</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true"></a>        plug <span class="va">:accepts</span>, [<span class="st">&quot;html&quot;</span>]</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true"></a>        plug <span class="va">:fetch_session</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true"></a>        plug <span class="va">:fetch_flash</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true"></a>        plug <span class="va">:protect_from_forgery</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true"></a>        plug <span class="va">:put_secure_browser_headers</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true"></a>    <span class="kw">end</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true"></a></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true"></a>    pipeline <span class="va">:api</span> <span class="kw">do</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true"></a>        plug <span class="va">:accepts</span>, [<span class="st">&quot;json&quot;</span>]</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true"></a>    <span class="kw">end</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true"></a></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true"></a>    scope <span class="st">&quot;/&quot;</span>, <span class="cn">TestPhoenixWeb</span> <span class="kw">do</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true"></a>        pipe_through <span class="va">:browser</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true"></a></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true"></a>        get <span class="st">&quot;/&quot;</span>, <span class="cn">PageController</span>, <span class="va">:index</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true"></a></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true"></a>        <span class="co">#Page Test</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true"></a>        get <span class="st">&quot;/test&quot;</span>, <span class="cn">TestController</span>, <span class="va">:index</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true"></a>    <span class="kw">end</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true"></a></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true"></a>    <span class="cf">if</span> <span class="cn">Mix</span><span class="op">.</span>env() <span class="kw">in</span> [<span class="va">:dev</span>, <span class="va">:test</span>] <span class="kw">do</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true"></a>        <span class="im">import</span> <span class="cn">Phoenix</span><span class="op">.</span><span class="cn">LiveDashboard</span><span class="op">.</span><span class="cn">Router</span></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true"></a></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true"></a>        scope <span class="st">&quot;/&quot;</span> <span class="kw">do</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true"></a>        pipe_through <span class="va">:browser</span></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true"></a>        live_dashboard <span class="st">&quot;/dashboard&quot;</span>, <span class="va">metrics:</span> <span class="cn">TestPhoenixWeb</span><span class="op">.</span><span class="cn">Telemetry</span></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true"></a>        <span class="kw">end</span></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true"></a>    <span class="kw">end</span></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true"></a><span class="kw">end</span></span></code></pre></div>
<p>Créer un nouveau controleur dans <code>lib/test_phoenix_web/controllers/test_controller.ex</code>:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true"></a><span class="kw">defmodule</span> <span class="cn">TestPhoenixWeb</span><span class="op">.</span><span class="cn">TestController</span> <span class="kw">do</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true"></a>    <span class="im">use</span> <span class="cn">TestPhoenixWeb</span>, <span class="va">:controller</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true"></a>    <span class="kw">def</span> index(conn, _params) <span class="kw">do</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true"></a>        render(conn, <span class="st">&quot;test.html&quot;</span>)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true"></a>    <span class="kw">end</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true"></a><span class="kw">end</span></span></code></pre></div>
<p>Créer la vue dans <code>lib/test_phoenix_web/views/test_view.ex</code>:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true"></a><span class="kw">defmodule</span> <span class="cn">TestPhoenixWeb</span><span class="op">.</span><span class="cn">TestView</span> <span class="kw">do</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true"></a>    <span class="im">use</span> <span class="cn">TestPhoenixWeb</span>, <span class="va">:view</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true"></a><span class="kw">end</span></span></code></pre></div>
<p>Puis le template <code>lib/test_phoenix_web/templates/test/test.html.eex</code>:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true"></a><span class="kw">&lt;section</span><span class="ot"> class=</span><span class="st">&quot;phx-hero&quot;</span><span class="kw">&gt;</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true"></a>  <span class="kw">&lt;h1&gt;</span><span class="er">&lt;</span>%= gettext &quot;Bienvenu sur %{name}!&quot;, name: &quot;Phoenix&quot; %&gt;<span class="kw">&lt;/h1&gt;</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true"></a>  <span class="kw">&lt;p&gt;</span>Page de test<span class="kw">&lt;/p&gt;</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true"></a><span class="kw">&lt;/section&gt;</span></span></code></pre></div>
<p>À noter que le template est inséré dans le layout <code>lib/test_phoenix_web/templates/layout/app.html.eex</code> grâce à la ligne <code>&lt;%= @inner_content %&gt;</code>.</p>
<h2 id="passer-un-paramètre-à-une-page"><a name="parametre"></a>Passer un paramètre à une page</h2>
<p>Ajouter <code>get "/test/:message", TestController, :show</code> dans <code>lib/test_phoenix_web/router.ex</code>:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true"></a><span class="kw">defmodule</span> <span class="cn">TestPhoenixWeb</span><span class="op">.</span><span class="cn">Router</span> <span class="kw">do</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true"></a>    <span class="im">use</span> <span class="cn">TestPhoenixWeb</span>, <span class="va">:router</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true"></a>    pipeline <span class="va">:browser</span> <span class="kw">do</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true"></a>        plug <span class="va">:accepts</span>, [<span class="st">&quot;html&quot;</span>]</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true"></a>        plug <span class="va">:fetch_session</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true"></a>        plug <span class="va">:fetch_flash</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true"></a>        plug <span class="va">:protect_from_forgery</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true"></a>        plug <span class="va">:put_secure_browser_headers</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true"></a>    <span class="kw">end</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true"></a></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true"></a>    pipeline <span class="va">:api</span> <span class="kw">do</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true"></a>        plug <span class="va">:accepts</span>, [<span class="st">&quot;json&quot;</span>]</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true"></a>    <span class="kw">end</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true"></a></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true"></a>    scope <span class="st">&quot;/&quot;</span>, <span class="cn">TestPhoenixWeb</span> <span class="kw">do</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true"></a>        pipe_through <span class="va">:browser</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true"></a></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true"></a>        get <span class="st">&quot;/&quot;</span>, <span class="cn">PageController</span>, <span class="va">:index</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true"></a>        get <span class="st">&quot;/test&quot;</span>, <span class="cn">TestController</span>, <span class="va">:index</span></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true"></a>        </span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true"></a>        <span class="co">#Gestion du paramètre</span></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true"></a>        get <span class="st">&quot;/test/:message&quot;</span>, <span class="cn">TestController</span>, <span class="va">:show</span></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true"></a>    <span class="kw">end</span></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true"></a></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true"></a>    <span class="cf">if</span> <span class="cn">Mix</span><span class="op">.</span>env() <span class="kw">in</span> [<span class="va">:dev</span>, <span class="va">:test</span>] <span class="kw">do</span></span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true"></a>        <span class="im">import</span> <span class="cn">Phoenix</span><span class="op">.</span><span class="cn">LiveDashboard</span><span class="op">.</span><span class="cn">Router</span></span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true"></a></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true"></a>        scope <span class="st">&quot;/&quot;</span> <span class="kw">do</span></span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true"></a>        pipe_through <span class="va">:browser</span></span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true"></a>        live_dashboard <span class="st">&quot;/dashboard&quot;</span>, <span class="va">metrics:</span> <span class="cn">TestPhoenixWeb</span><span class="op">.</span><span class="cn">Telemetry</span></span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true"></a>        <span class="kw">end</span></span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true"></a>    <span class="kw">end</span></span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true"></a><span class="kw">end</span></span></code></pre></div>
<p>Définir la fonction <code>show</code> dans <code>lib/test_phoenix_web/controllers/test_controller.ex</code>:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true"></a><span class="kw">defmodule</span> <span class="cn">TestPhoenixWeb</span><span class="op">.</span><span class="cn">TestController</span> <span class="kw">do</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true"></a>    <span class="im">use</span> <span class="cn">TestPhoenixWeb</span>, <span class="va">:controller</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true"></a>    <span class="kw">def</span> index(conn, _params) <span class="kw">do</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true"></a>        render(conn, <span class="st">&quot;test.html&quot;</span>)</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true"></a>    <span class="kw">end</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true"></a></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true"></a>    <span class="co">#Gestion du paramètre</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true"></a>    <span class="kw">def</span> show(conn, %{<span class="st">&quot;message&quot;</span> <span class="op">=&gt;</span> message}) <span class="kw">do</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true"></a>        render(conn, <span class="st">&quot;show.html&quot;</span>, <span class="va">message:</span> message)</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true"></a>    <span class="kw">end</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true"></a>    </span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true"></a>    <span class="co">#Autre possibilité avec pattern matching</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true"></a>    <span class="kw">def</span> show(conn, %{<span class="st">&quot;message&quot;</span> <span class="op">=&gt;</span> message} <span class="op">=</span> params) <span class="kw">do</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true"></a>        render(conn, <span class="st">&quot;show.html&quot;</span>, <span class="va">message:</span> message)</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true"></a>    <span class="kw">end</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true"></a>    </span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true"></a>    <span class="co">#Avec plusieurs paramètres</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true"></a>    <span class="kw">def</span> show(conn, %{<span class="st">&quot;message&quot;</span> <span class="op">=&gt;</span> message}) <span class="kw">do</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true"></a>        conn</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true"></a>        <span class="op">|&gt;</span> <span class="cn">Plug</span><span class="op">.</span><span class="cn">Conn</span><span class="op">.</span>assign(<span class="va">:message</span>, message)</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true"></a>        <span class="op">|&gt;</span> <span class="cn">Plug</span><span class="op">.</span><span class="cn">Conn</span><span class="op">.</span>assign(<span class="va">:other</span>, <span class="st">&quot;other&quot;</span>)</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true"></a>        <span class="op">|&gt;</span> render(<span class="st">&quot;show.html&quot;</span>)</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true"></a>    <span class="kw">end</span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true"></a>    </span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true"></a>    <span class="co">#Pour ne pas utiliser de vue/template:</span></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true"></a>    <span class="co">#def show(conn, %{&quot;message&quot; =&gt; message}) do</span></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true"></a>    <span class="co">#    html(conn, &quot;&quot;&quot;</span></span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true"></a>    <span class="co">#    &lt;html&gt;</span></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true"></a>    <span class="co">#        &lt;head&gt;</span></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true"></a>    <span class="co">#            &lt;title&gt;Paramètre&lt;/title&gt;</span></span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true"></a>    <span class="co">#        &lt;/head&gt;</span></span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true"></a>    <span class="co">#        &lt;body&gt;</span></span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true"></a>    <span class="co">#        &lt;p&gt;Message: #{Plug.HTML.html_escape(message)}&lt;/p&gt;</span></span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true"></a>    <span class="co">#        &lt;/body&gt;</span></span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true"></a>    <span class="co">#    &lt;/html&gt;</span></span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true"></a>    <span class="co">#    &quot;&quot;&quot;)</span></span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true"></a>    <span class="co">#end</span></span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true"></a><span class="kw">end</span></span></code></pre></div>
<p>Créer le template <code>lib/test_phoenix_web/templates/test/show.html.eex</code>:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true"></a><span class="kw">&lt;section</span><span class="ot"> class=</span><span class="st">&quot;phx-hero&quot;</span><span class="kw">&gt;</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true"></a>  <span class="kw">&lt;h2&gt;</span>Bienvenu sur <span class="er">&lt;</span>%= @message %&gt;!<span class="kw">&lt;/h2&gt;</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true"></a>  <span class="kw">&lt;p&gt;</span><span class="er">&lt;</span>%= gettext &quot;Bienvenu sur %{message}!&quot;, message: @message %&gt;<span class="kw">&lt;/p&gt;</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true"></a><span class="kw">&lt;/section&gt;</span></span></code></pre></div>
<p>Après avoir accédé à l'URL <code>http://localhost:4000/test/bonjour</code>on peut voir le paramètre affiché. Dans la console IEx on peut observer les détails suivants:</p>
<pre class="console"><code>[info] GET /test/bonjour
[debug] Processing with TestPhoenixWeb.TestController.show/2
  Parameters: %{&quot;message&quot; =&gt; &quot;bonjour&quot;}
  Pipelines: [:browser]
[info] Sent 200 in 450µs</code></pre>
<h2 id="liveview-actualiser-les-éléments-dune-page-sans-la-refaraîchir"><a name="liveview"></a>LiveView: actualiser les éléments d'une page sans la refaraîchir</h2>
<p>LiveView nécessite JetPack (dépendances NodeJS à ne pas exclure):</p>
<pre class="console"><code>mix phx.new live_test --no-ecto --live</code></pre>
<p>S'assurer de la présence de LiveView comme dépendance dans <code>mix.exs</code> (puis installer avec <code>mix deps.get</code>):</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true"></a>{<span class="va">:phoenix_live_view</span>, <span class="st">&quot;~&gt; 0.14.7&quot;</span>}</span></code></pre></div>
<p>Créer une entrée dans <code>live_test/lib/live_test_web/router.ex</code>:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true"></a>live <span class="st">&quot;/counter&quot;</span>, <span class="cn">CounterLive</span></span></code></pre></div>
<p>Créer un module <code>CounterLive</code> dans <code>live_test/lib/live_test_web/live/counter_live.ex</code>:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true"></a><span class="kw">defmodule</span> <span class="cn">LiveTestWeb</span><span class="op">.</span><span class="cn">CounterLive</span> <span class="kw">do</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true"></a>    <span class="im">use</span> <span class="cn">LiveTestWeb</span>, <span class="va">:live_view</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true"></a>    <span class="co">#use Phoenix.LiveView</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true"></a>    <span class="co">#Pour utiliser directement CounterView.render au lieu de LiveTestWeb.CounterView.render dans render/1:</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true"></a>    <span class="co">#alias LiveViewCounterWeb.CounterView </span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true"></a></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true"></a>    <span class="kw">def</span> render(assigns) <span class="kw">do</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true"></a>        <span class="cn">LiveTestWeb</span><span class="op">.</span><span class="cn">CounterView</span><span class="op">.</span>render(<span class="st">&quot;index.html&quot;</span>, assigns)</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true"></a>    <span class="kw">end</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true"></a>    </span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true"></a>    <span class="co">#Pour ne pas utiliser de vue/template:</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true"></a>    <span class="co">#def render(assigns) do</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true"></a>    <span class="co">#~L&quot;&quot;&quot;</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true"></a>    <span class="co">#&lt;div&gt;</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true"></a>    <span class="co">#    &lt;h1&gt;The count is: &lt;%= @val %&gt;&lt;/h1&gt;</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true"></a>    <span class="co">#    &lt;button phx-click=&quot;dec&quot;&gt;-&lt;/button&gt;</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true"></a>    <span class="co">#    &lt;button phx-click=&quot;inc&quot;&gt;+&lt;/button&gt;</span></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true"></a>    <span class="co">#    &lt;button phx-click=&quot;reset&quot;&gt;Reset&lt;/button&gt;</span></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true"></a>    <span class="co">#&lt;/div&gt;</span></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true"></a>    <span class="co">#&quot;&quot;&quot;</span></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true"></a>    <span class="co">#end</span></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true"></a></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true"></a>    <span class="co">#Exécuté au chargement de la page, intialise la valeur à 0</span></span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true"></a>    <span class="kw">def</span> mount(_params, _session, socket) <span class="kw">do</span></span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true"></a>        {<span class="va">:ok</span>, assign(socket, <span class="va">:val</span>, <span class="dv">0</span>)}</span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true"></a>    <span class="kw">end</span></span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true"></a></span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true"></a>    <span class="co">#Exécuté sur l&#39;évènement &quot;inc&quot;: incrémente la valeur actuelle</span></span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true"></a>    <span class="kw">def</span> handle_event(<span class="st">&quot;inc&quot;</span>, _value, socket) <span class="kw">do</span></span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true"></a>        {<span class="va">:noreply</span>, update(socket, <span class="va">:val</span>, <span class="op">&amp;</span>(<span class="op">&amp;</span><span class="dv">1</span> <span class="op">+</span> <span class="dv">1</span>))}</span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true"></a>    <span class="kw">end</span></span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true"></a></span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true"></a>    <span class="co">#Exécuté sur l&#39;évènement &quot;dec&quot;: décrémente la valeur actuelle</span></span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true"></a>    <span class="kw">def</span> handle_event(<span class="st">&quot;dec&quot;</span>, _value, socket) <span class="kw">do</span></span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true"></a>        {<span class="va">:noreply</span>, update(socket, <span class="va">:val</span>, <span class="op">&amp;</span>(<span class="op">&amp;</span><span class="dv">1</span> <span class="op">-</span> <span class="dv">1</span>))}</span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true"></a>    <span class="kw">end</span></span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true"></a>    </span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true"></a>    <span class="co">#Exécuté sur l&#39;évènement &quot;reset&quot;: passe la valeur actuelle à 0</span></span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true"></a>    <span class="kw">def</span> handle_event(<span class="st">&quot;reset&quot;</span>, _value, socket) <span class="kw">do</span></span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true"></a>        {<span class="va">:noreply</span>, update(socket, <span class="va">:val</span>, <span class="op">&amp;</span>(<span class="op">&amp;</span><span class="dv">1</span> <span class="op">-</span> <span class="op">&amp;</span><span class="dv">1</span>))}</span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true"></a>    <span class="kw">end</span></span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true"></a><span class="kw">end</span></span></code></pre></div>
<p>Créer un template dans <code>live_test/lib/live_test_web/templates/counter/index.html.leex</code>:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true"></a><span class="kw">&lt;div&gt;</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true"></a>  <span class="kw">&lt;h1</span><span class="ot"> phx-click=</span><span class="st">&quot;reset&quot;</span><span class="kw">&gt;</span>The count is: <span class="er">&lt;</span>%= @val %&gt;<span class="kw">&lt;/h1&gt;</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true"></a>  <span class="kw">&lt;button</span><span class="ot"> phx-click=</span><span class="st">&quot;dec&quot;</span><span class="kw">&gt;</span>-<span class="kw">&lt;/button&gt;</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true"></a>  <span class="kw">&lt;button</span><span class="ot"> phx-click=</span><span class="st">&quot;inc&quot;</span><span class="kw">&gt;</span>+<span class="kw">&lt;/button&gt;</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true"></a>  <span class="kw">&lt;button</span><span class="ot"> phx-click=</span><span class="st">&quot;reset&quot;</span><span class="kw">&gt;</span>Reset<span class="kw">&lt;/button&gt;</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true"></a><span class="kw">&lt;/div&gt;</span></span></code></pre></div>
<p>Créer une vue dans <code>live_test/lib/live_test_web/views/counter_view.ex</code>:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true"></a><span class="kw">defmodule</span> <span class="cn">LiveTestWeb</span><span class="op">.</span><span class="cn">CounterView</span> <span class="kw">do</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true"></a>    <span class="im">use</span> <span class="cn">LiveTestWeb</span>, <span class="va">:view</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true"></a><span class="kw">end</span></span></code></pre></div>
<figure>
<img src="liveview_counter.jpg" title="Rendu de la vue (inclue dans le layout)" alt="" /><figcaption>Rendu de la vue (inclue dans le layout)</figcaption>
</figure>
<h2 id="liveview-et-pubsub-communication-entre-differents-clients"><a name="pubsub"></a>LiveView et PubSub: communication entre differents clients</h2>
<p>Pour qu'une valeur soit synchronisée entre tous les clients, nous allons utiliser le système PubSub. Dès qu'un client modifie la valeur, elle sera transmise à tous les clients qui l'afficheront.</p>
<p>Ajouter la dépendance <code>phoenix_pubsub</code> dans <code>mix.exs</code> puis exécuter <code>mix deps.get</code>:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true"></a>{<span class="va">:phoenix_pubsub</span>, <span class="st">&quot;~&gt; 2.0&quot;</span>}</span></code></pre></div>
<p>Ajouter le système PubSub dans l'arbre de supervision <code>live_test/lib/live_test/application.ex</code>:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true"></a><span class="kw">def</span> start(_type, _args) <span class="kw">do</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true"></a>    children <span class="op">=</span> [</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true"></a>        <span class="co"># Start the Telemetry supervisor</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true"></a>        <span class="cn">LiveTestWeb</span><span class="op">.</span><span class="cn">Telemetry</span>,</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true"></a></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true"></a>        <span class="co"># Start the PubSub system</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true"></a>        {<span class="cn">Phoenix</span><span class="op">.</span><span class="cn">PubSub</span>, <span class="va">name:</span> <span class="cn">LiveTest</span><span class="op">.</span><span class="cn">PubSub</span>},</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true"></a>        </span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true"></a>        <span class="co"># Start the Endpoint (http/https)</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true"></a>        <span class="cn">LiveTestWeb</span><span class="op">.</span><span class="cn">Endpoint</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true"></a>        <span class="co"># Start a worker by calling: LiveTest.Worker.start_link(arg)</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true"></a>        <span class="co"># {LiveTest.Worker, arg}</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true"></a>    ]</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true"></a></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true"></a>    <span class="co"># See https://hexdocs.pm/elixir/Supervisor.html</span></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true"></a>    <span class="co"># for other strategies and supported options</span></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true"></a>    opts <span class="op">=</span> [<span class="va">strategy:</span> <span class="va">:one_for_one</span>, <span class="va">name:</span> <span class="cn">LiveTest</span><span class="op">.</span><span class="cn">Supervisor</span>]</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true"></a>    <span class="cn">Supervisor</span><span class="op">.</span>start_link(children, opts)</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true"></a><span class="kw">end</span></span></code></pre></div>
<p>Modification du controleur <code>CounterLive</code> dans <code>live_test/lib/live_test_web/live/counter_live.ex</code>:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true"></a><span class="kw">defmodule</span> <span class="cn">LiveTestWeb</span><span class="op">.</span><span class="cn">CounterLive</span> <span class="kw">do</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true"></a>    <span class="im">use</span> <span class="cn">LiveTestWeb</span>, <span class="va">:live_view</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true"></a>    <span class="co">#use Phoenix.LiveView</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true"></a>    </span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true"></a>    <span class="co">#Pour utiliser directement CounterView.render au lieu de LiveTestWeb.CounterView.render dans render/1:</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true"></a>    <span class="co">#alias LiveViewCounterWeb.CounterView </span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true"></a></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true"></a>    <span class="kw">def</span> render(assigns) <span class="kw">do</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true"></a>        <span class="cn">LiveTestWeb</span><span class="op">.</span><span class="cn">CounterView</span><span class="op">.</span>render(<span class="st">&quot;index.html&quot;</span>, assigns)</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true"></a>    <span class="kw">end</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true"></a></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true"></a>    <span class="co">#Inscription au topic &quot;val_changes&quot; et initialisation de la valeur à 0</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true"></a>    <span class="kw">def</span> mount(_params, _session, socket) <span class="kw">do</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true"></a>        <span class="cn">Phoenix</span><span class="op">.</span><span class="cn">PubSub</span><span class="op">.</span>subscribe(<span class="cn">LiveTest</span><span class="op">.</span><span class="cn">PubSub</span>, <span class="st">&quot;val_changes&quot;</span>)</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true"></a>        {<span class="va">:ok</span>, assign(socket, <span class="va">:val</span>, <span class="dv">0</span>)}</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true"></a>    <span class="kw">end</span></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true"></a></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true"></a>    <span class="co">#Diffuse sur le topic &quot;val_changes&quot; la valeur incrémentée</span></span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true"></a>    <span class="kw">def</span> handle_event(<span class="st">&quot;inc&quot;</span>, _value, socket) <span class="kw">do</span></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true"></a>        <span class="cn">Phoenix</span><span class="op">.</span><span class="cn">PubSub</span><span class="op">.</span>broadcast(<span class="cn">LiveTest</span><span class="op">.</span><span class="cn">PubSub</span>, <span class="st">&quot;val_changes&quot;</span>, socket<span class="op">.</span>assigns[<span class="va">:val</span>] <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true"></a>        {<span class="va">:noreply</span>, socket}</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true"></a>    <span class="kw">end</span></span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true"></a></span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true"></a>    <span class="co">#Diffuse sur le topic &quot;val_changes&quot; la valeur décrémentée</span></span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true"></a>    <span class="kw">def</span> handle_event(<span class="st">&quot;dec&quot;</span>, _value, socket) <span class="kw">do</span></span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true"></a>        <span class="cn">Phoenix</span><span class="op">.</span><span class="cn">PubSub</span><span class="op">.</span>broadcast(<span class="cn">LiveTest</span><span class="op">.</span><span class="cn">PubSub</span>, <span class="st">&quot;val_changes&quot;</span>, socket<span class="op">.</span>assigns[<span class="va">:val</span>] <span class="op">-</span> <span class="dv">1</span>)</span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true"></a>        {<span class="va">:noreply</span>, socket}</span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true"></a>    <span class="kw">end</span></span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true"></a></span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true"></a>    <span class="co">#Diffuse sur le topic &quot;val_changes&quot; la valeur décrémentée</span></span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true"></a>    <span class="kw">def</span> handle_event(<span class="st">&quot;reset&quot;</span>, _value, socket) <span class="kw">do</span></span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true"></a>        <span class="cn">Phoenix</span><span class="op">.</span><span class="cn">PubSub</span><span class="op">.</span>broadcast(<span class="cn">LiveTest</span><span class="op">.</span><span class="cn">PubSub</span>, <span class="st">&quot;val_changes&quot;</span>, <span class="dv">0</span>)</span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true"></a>        {<span class="va">:noreply</span>, socket}</span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true"></a>    <span class="kw">end</span></span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true"></a></span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true"></a>    <span class="co">#Réception en provenance du topic &quot;val_changes&quot;: Met à jour la valeur affichée avec celle reçue</span></span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true"></a>    <span class="kw">def</span> handle_info(msg, socket) <span class="kw">do</span></span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true"></a>        <span class="co">#IO.inspect(msg)</span></span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true"></a>        {<span class="va">:noreply</span>, update(socket, <span class="va">:val</span>, <span class="kw">fn</span> (_) <span class="op">-&gt;</span> msg <span class="kw">end</span> )}</span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true"></a>    <span class="kw">end</span></span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true"></a><span class="kw">end</span></span></code></pre></div>
<h2 id="liens-complémentaires">Liens complémentaires</h2>
<ul>
<li><a href="https://hexdocs.pm/phoenix/installation.html#phoenix">Installation de Phoenix</a></li>
<li><a href="https://hexdocs.pm/phoenix/request_lifecycle.html#content">Transite d'une requête à travers Phoenix</a></li>
<li><a href="https://hexdocs.pm/phoenix/controllers.html#content">Les controleurs</a></li>
<li><a href="https://hexdocs.pm/phoenix_live_view/Phoenix.LiveView.html">LiveView</a></li>
<li><a href="http://blog.pthompson.org/liveview-livecomponents-introduction">LiveView et LiveComponents</a></li>
<li><a href="https://dennisbeatty.com/how-to-create-a-counter-with-phoenix-live-view.html">Create a counter with Phoenix LiveView</a></li>
<li><a href="https://hexdocs.pm/phoenix_pubsub/Phoenix.PubSub.html">Phoenix PubSub</a></li>
</ul>
</article>
</main>

<footer id="footer">
  © 2015-2021 C. Boyer, contenu sous licence <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.fr">Creative Commons BY-SA-NC 4.0</a>, l'ensemble des codes sources sont sous licence <a href="https://www.gnu.org/licenses/gpl-3.0.fr.html">GNU GPL v3</a>
</footer>

</body>
</html>
