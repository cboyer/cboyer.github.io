<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="HandheldFriendly" content="True">
  <title>Implémentation du protocole Zabbix dans Mirth Connect - C. Boyer</title>
  <meta name="description" content="Implémenter l’agent Zabbix dans Mirth via un canal de type TCP Listener." />
  <meta name="author" content="C. Boyer" />
  <meta name="keywords" content="zabbix, mirth, mirth connect, monitoring" />
  <link rel="canonical" href="https://cboyer.github.io/developpement/zabbix-protocole-mirth" />
  <meta property="og:title" content="Implémentation du protocole Zabbix dans Mirth Connect - C. Boyer" />
  <meta property="og:locale" content="fr_CA" />
  <meta property="og:description" content="Implémenter l’agent Zabbix dans Mirth via un canal de type TCP Listener." />
  <meta property="og:site_name" content="cboyer.github.io" />
  <meta property="og:type" content="website" />
  <meta property="og:updated_time" content="2019-03-03T17:39:47-04:00" />
  <meta property="article:published_time" content="2018-12-08T18:23:15-04:00" />
  <meta property="article:modified_time" content="2019-03-03T17:39:47-04:00" />
  <meta name="generator" content="pandoc" />
  <meta name="robots" content="index,follow">
  <link rel="icon" href="data:;base64,iVBORw0KGgo=">
  <link href="https://cboyer.github.io/atom.xml" rel="alternate" type="application/atom+xml" />
  <link rel="stylesheet" type="text/css" href="../../style.css" />
  <style>
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style>
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; position: absolute; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; }
pre.numberSource a.sourceLine:empty
  { position: absolute; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: absolute; left: -5em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    background-color: #ffffff;
    color: #a0a0a0;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #a0a0a0;  padding-left: 4px; }
div.sourceCode
  { color: #1f1c1b; background-color: #ffffff; }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span. { color: #1f1c1b; } /* Normal */
code span.al { color: #bf0303; background-color: #f7e6e6; font-weight: bold; } /* Alert */
code span.an { color: #ca60ca; } /* Annotation */
code span.at { color: #0057ae; } /* Attribute */
code span.bn { color: #b08000; } /* BaseN */
code span.bu { color: #644a9b; font-weight: bold; } /* BuiltIn */
code span.cf { color: #1f1c1b; font-weight: bold; } /* ControlFlow */
code span.ch { color: #924c9d; } /* Char */
code span.cn { color: #aa5500; } /* Constant */
code span.co { color: #898887; } /* Comment */
code span.cv { color: #0095ff; } /* CommentVar */
code span.do { color: #607880; } /* Documentation */
code span.dt { color: #0057ae; } /* DataType */
code span.dv { color: #b08000; } /* DecVal */
code span.er { color: #bf0303; text-decoration: underline; } /* Error */
code span.ex { color: #0095ff; font-weight: bold; } /* Extension */
code span.fl { color: #b08000; } /* Float */
code span.fu { color: #644a9b; } /* Function */
code span.im { color: #ff5500; } /* Import */
code span.in { color: #b08000; } /* Information */
code span.kw { color: #1f1c1b; font-weight: bold; } /* Keyword */
code span.op { color: #1f1c1b; } /* Operator */
code span.ot { color: #006e28; } /* Other */
code span.pp { color: #006e28; } /* Preprocessor */
code span.re { color: #0057ae; background-color: #e0e9f8; } /* RegionMarker */
code span.sc { color: #3daee9; } /* SpecialChar */
code span.ss { color: #ff5500; } /* SpecialString */
code span.st { color: #bf0303; } /* String */
code span.va { color: #0057ae; } /* Variable */
code span.vs { color: #bf0303; } /* VerbatimString */
code span.wa { color: #bf0303; } /* Warning */
  </style>
</head>
<body>
  <div id="header">
    <div id="site_title">
      <h1>cboyer.github.io</h1>
    </div>
    <div id="links">
      <a href="../../rechercher.html" class="search" title="Rechercher">
          <svg class="button" aria-labelledby="search-icon" role="img" viewBox="5 5 21 21" xmlns="http://www.w3.org/2000/svg">
            <title id="search-icon">Rechercher</title>
            <path d="M27 24.57l-5.647-5.648a8.895 8.895 0 0 0 1.522-4.984C22.875 9.01 18.867 5 13.938 5 9.01 5 5 9.01 5 13.938c0 4.929 4.01 8.938 8.938 8.938a8.887 8.887 0 0 0 4.984-1.522L24.568 27 27 24.57zm-13.062-4.445a6.194 6.194 0 0 1-6.188-6.188 6.195 6.195 0 0 1 6.188-6.188 6.195 6.195 0 0 1 6.188 6.188 6.195 6.195 0 0 1-6.188 6.188z"/>
          </svg>
      </a>
      <a href="https://github.com/cboyer" class="github" title="GitHub" target="_blank">
          <svg class="button" aria-labelledby="github-icon" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <title id="github-icon">GitHub</title>
            <path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"></path>
          </svg>
      </a>
      <a href="../../atom.xml" class="rss" title="Flux Atom">
          <svg class="button" aria-labelledby="atom-icon" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <title id="atom-icon">Flux Atom</title>
            <path d="M19.199 24C19.199 13.467 10.533 4.8 0 4.8V0c13.165 0 24 10.835 24 24h-4.801zM3.291 17.415c1.814 0 3.293 1.479 3.293 3.295 0 1.813-1.485 3.29-3.301 3.29C1.47 24 0 22.526 0 20.71s1.475-3.294 3.291-3.295zM15.909 24h-4.665c0-6.169-5.075-11.245-11.244-11.245V8.09c8.727 0 15.909 7.184 15.909 15.91z"></path>
          </svg>
      </a>
    </div>

    <div id="menu">
      <ul class="menu">
        <li class="menu_item"><a href="../../index.html">Index</a></li>
        <li class="menu_item active"><a href="../../developpement.html">Développement</a></li>
        <li class="menu_item"><a href="../../linux.html">Linux</a></li>
        <li class="menu_item"><a href="../../electronique.html">Électronique</a></li>
        <li class="menu_item"><a href="../../apropos.html">À propos</a></li>
      </ul>
    </div>
  </div>

  <div id="container">
<article>
<header id="title-block-header">
<h2 class="title">Implémentation du protocole Zabbix dans Mirth Connect</h2>
 <span class="author">C. Boyer</span>,   <span class="date">2018-12-08 18:23:15 (UTC-04:00)</span>
</header>
<p>L’objectif est d’implémenter un agent <a href="https://www.zabbix.com/">Zabbix</a> dans <a href="https://www.nextgen.com/products-and-services/NextGen-Connect-Integration-Engine-Downloads">Mirth Connect</a> comme n’importe quel autre échange de données afin de monitorer l’activité de ce dernier (erreurs, statuts, volumes de transactions, etc.). L’intégralité du code source de ce projet est disponible sur Github (licence GPLv3): <a href="https://github.com/cboyer/mirth-zabbix" class="uri">https://github.com/cboyer/mirth-zabbix</a>.</p>
<p>Le monitoring avec Zabbix repose sur un serveur chargé de collecter les données auprès des équipements notamment via un agent (Zabbix peut également utiliser d’autres standards comme SNMP). Cette stratégie de “polling” implique dans un premier temps une connexion à l’agent pour l’interroger concernant la valeur d’une métrique (clé) que ce dernier lui retournera.</p>
<h2 id="le-protocole-zabbix">Le protocole Zabbix</h2>
<p>Zabbix utilise un protocole relativement simple: il repose sur des échanges de données au format JSON sur TCP. Étant une technologie libre et open source nous disposons du code source de l’agent Zabbix ainsi qu’une excellente documentation pour en comprendre le fonctionnement (cf. sources en bas de page).</p>
<p>Zabbix structure ses messages de la façon suivante:</p>
<pre class="console"><code>&lt;Entête&gt; &lt;Quantité des données&gt; &lt;Données&gt;</code></pre>
<table>
<thead>
<tr class="header">
<th style="text-align: center;"> </th>
<th style="text-align: center;">Entête</th>
<th style="text-align: center;">Quantité de données</th>
<th style="text-align: center;">Données</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;"><strong>Type</strong></td>
<td style="text-align: center;">Chaîne de caractères</td>
<td style="text-align: center;">Entier (little endian)</td>
<td style="text-align: center;">Chaîne de caractères</td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>Taille</strong></td>
<td style="text-align: center;">5 octets</td>
<td style="text-align: center;">8 octets</td>
<td style="text-align: center;">Variable, maximum 134217728 octets</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><strong>Contenu</strong></td>
<td style="text-align: center;">“ZBXD\x01”</td>
<td style="text-align: center;">Taille du champ Données</td>
<td style="text-align: center;">Données de monitoring (JSON)</td>
</tr>
</tbody>
</table>
<p>L’entête est une chaîne de caractères fixe: <code>&quot;ZBXD\x01&quot;</code>. Elle est composée de la chaîne <code>ZBXD</code> et de l’octet <code>0x01</code>. La quantité de données est un entier non signé sur 8 octets en little-endian qui représente la longueur de la chaîne contenant les données JSON. Zabbix est limité à une quantité maximale de 134217728 octets. Les données envoyées sont en texte clair au format JSON (Zabbix peut crypter ses échanges, cas que nous ne traiterons pas ici).</p>
<h2 id="mirth-connect">Mirth Connect</h2>
<p>Pour imiter le fonctionnement de l’agent Zabbix avec un canal Mirth un connecteur source de type TCP Listener est nécessaire afin d’accepter les connexions en provenance du serveur Zabbix. Ce connecteur doit utiliser la même connexion TCP pour être interroger (recevoir la clé) et envoyer la donnée correspondante à la métrique demandée. Il doit également fonctionner en mode binaire car nous avons besoin de travailler avec des octets sans qu’ils soient altérés par les standards d’encodage (UTF-8, etc.) liés aux chaînes de caractères. Le caractère <code>0x0A</code> (LF) sera utilisé comme indicateur de fin de message. Tous ces paramètres sont configurables directement dans Mirth sans la moindre ligne de code.</p>
<figure>
<img src="mirth_source.png" alt="Configuration du connecteur source" /><figcaption>Configuration du connecteur source</figcaption>
</figure>
<p>Une fois le connecteur source mis en place, nous allons faire appel à un <a href="https://github.com/cboyer/mirth-zabbix/blob/master/src/destination_transformer.js">transformer</a> afin de récupérer les données demandées par le serveur et les transmettre au connecteur de destination. C’est ici que sont centralisées les fonctionnalités de l’agent Zabbix, plus précisément les clés supportées. Concrètement il s’agit un simple <code>switch</code> pour exécuter du code en fonction de la métrique demandée par le serveur:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="cf">switch</span> (item_requested) <span class="op">{</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2"></a>
<a class="sourceLine" id="cb2-3" data-line-number="3">    <span class="cf">case</span> <span class="st">&#39;agent.ping&#39;</span><span class="op">:</span></a>
<a class="sourceLine" id="cb2-4" data-line-number="4">        msg <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></a>
<a class="sourceLine" id="cb2-5" data-line-number="5">        <span class="cf">break</span><span class="op">;</span></a>
<a class="sourceLine" id="cb2-6" data-line-number="6"></a>
<a class="sourceLine" id="cb2-7" data-line-number="7">    <span class="cf">case</span> <span class="st">&#39;agent.version&#39;</span><span class="op">:</span></a>
<a class="sourceLine" id="cb2-8" data-line-number="8">        msg <span class="op">=</span> <span class="st">&#39;Mirthix 1.1.0&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb2-9" data-line-number="9">        <span class="cf">break</span><span class="op">;</span></a>
<a class="sourceLine" id="cb2-10" data-line-number="10"></a>
<a class="sourceLine" id="cb2-11" data-line-number="11">    <span class="cf">case</span> <span class="st">&#39;agent.hostname&#39;</span><span class="op">:</span></a>
<a class="sourceLine" id="cb2-12" data-line-number="12">    <span class="cf">case</span> <span class="st">&#39;system.uname&#39;</span><span class="op">:</span></a>
<a class="sourceLine" id="cb2-13" data-line-number="13">        msg <span class="op">=</span> <span class="va">com</span>.<span class="va">mirth</span>.<span class="va">connect</span>.<span class="va">server</span>.<span class="va">controllers</span>.<span class="va">ConfigurationController</span>.<span class="at">getInstance</span>().<span class="at">getServerName</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb2-14" data-line-number="14">        <span class="cf">break</span><span class="op">;</span></a>
<a class="sourceLine" id="cb2-15" data-line-number="15"></a>
<a class="sourceLine" id="cb2-16" data-line-number="16">    <span class="dt">default</span><span class="op">:</span></a>
<a class="sourceLine" id="cb2-17" data-line-number="17">        msg <span class="op">=</span> <span class="st">&quot;ZBX_NOTSUPPORTED</span><span class="sc">\x00</span><span class="st">Key not implemented in Mirthix: &quot;</span> <span class="op">+</span> item_requested<span class="op">;</span></a>
<a class="sourceLine" id="cb2-18" data-line-number="18"><span class="op">}</span></a></code></pre></div>
<p>Pour le <a href="https://github.com/cboyer/mirth-zabbix/blob/master/src/destination.js">connecteur de destination</a> (chargé d’envoyer les données au serveur Zabbix), nous devrons implémenter le protocole Zabbix avec le header, la longueur des données sur 8 octets en little-endian et les données. Voici le code du connecteur de destination:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw">var</span> header <span class="op">=</span> <span class="st">&quot;ZBXD</span><span class="sc">\x01</span><span class="st">&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="kw">var</span> data <span class="op">=</span> <span class="va">connectorMessage</span>.<span class="at">getEncodedData</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb3-3" data-line-number="3"></a>
<a class="sourceLine" id="cb3-4" data-line-number="4"><span class="kw">var</span> header_bytes <span class="op">=</span> <span class="kw">new</span> <span class="va">java</span>.<span class="va">lang</span>.<span class="at">String</span>(header).<span class="at">getBytes</span>(<span class="st">&#39;UTF-8&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb3-5" data-line-number="5"><span class="kw">var</span> data_bytes <span class="op">=</span> <span class="kw">new</span> <span class="va">java</span>.<span class="va">lang</span>.<span class="at">String</span>(data).<span class="at">getBytes</span>(<span class="st">&#39;UTF-8&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb3-6" data-line-number="6"></a>
<a class="sourceLine" id="cb3-7" data-line-number="7"><span class="cf">if</span> (<span class="va">data_bytes</span>.<span class="at">length</span> <span class="op">+</span> <span class="dv">1</span> <span class="op">&gt;=</span> <span class="dv">134217728</span>) <span class="op">{</span> <span class="co">// +1 pour le caractère final 0x0A (LF)</span></a>
<a class="sourceLine" id="cb3-8" data-line-number="8">  <span class="cf">throw</span>(<span class="st">&#39;Message exceeds the maximum size 134217728 bytes.&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb3-9" data-line-number="9"><span class="op">}</span></a>
<a class="sourceLine" id="cb3-10" data-line-number="10"></a>
<a class="sourceLine" id="cb3-11" data-line-number="11"><span class="kw">var</span> length_bytes <span class="op">=</span> <span class="va">Packages</span>.<span class="va">java</span>.<span class="va">nio</span>.<span class="va">ByteBuffer</span>.<span class="at">allocate</span>(<span class="dv">8</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb3-12" data-line-number="12"><span class="va">length_bytes</span>.<span class="at">order</span>(<span class="va">java</span>.<span class="va">nio</span>.<span class="va">ByteOrder</span>.<span class="at">LITTLE_ENDIAN</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb3-13" data-line-number="13"><span class="va">length_bytes</span>.<span class="at">putInt</span>(<span class="va">data_bytes</span>.<span class="at">length</span> <span class="op">+</span> <span class="dv">1</span>)<span class="op">;</span> <span class="co">// +1 pour le caractère final 0x0A (LF)</span></a>
<a class="sourceLine" id="cb3-14" data-line-number="14"></a>
<a class="sourceLine" id="cb3-15" data-line-number="15"><span class="kw">var</span> zabbix_message_bytes <span class="op">=</span> <span class="va">Packages</span>.<span class="va">java</span>.<span class="va">nio</span>.<span class="va">ByteBuffer</span>.<span class="at">allocate</span>(<span class="va">header_bytes</span>.<span class="at">length</span> <span class="op">+</span> <span class="va">length_bytes</span>.<span class="at">array</span>().<span class="at">length</span> <span class="op">+</span> <span class="va">data_bytes</span>.<span class="at">length</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb3-16" data-line-number="16"><span class="va">zabbix_message_bytes</span>.<span class="at">put</span>(header_bytes)<span class="op">;</span></a>
<a class="sourceLine" id="cb3-17" data-line-number="17"><span class="va">zabbix_message_bytes</span>.<span class="at">put</span>(<span class="va">length_bytes</span>.<span class="at">array</span>())<span class="op">;</span></a>
<a class="sourceLine" id="cb3-18" data-line-number="18"><span class="va">zabbix_message_bytes</span>.<span class="at">put</span>(data_bytes)<span class="op">;</span></a>
<a class="sourceLine" id="cb3-19" data-line-number="19"></a>
<a class="sourceLine" id="cb3-20" data-line-number="20"><span class="cf">return</span> <span class="va">Packages</span>.<span class="va">org</span>.<span class="va">apache</span>.<span class="va">commons</span>.<span class="va">codec</span>.<span class="va">binary</span>.<span class="va">Base64</span>.<span class="at">encodeBase64String</span>(<span class="va">zabbix_message_bytes</span>.<span class="at">array</span>())<span class="op">;</span></a></code></pre></div>
<p>Notons qu’il est nécessaire d’encoder le message en base 64 pour fonctionner en mode binaire dans Mirth. Coté Zabbix toute la configuration s’effectue via un <a href="https://github.com/cboyer/mirth-zabbix/blob/master/Zabbix/Zabbix_template.xml">template</a> pour la définition des items/clés à monitorer.</p>
<h2 id="sources">Sources</h2>
<ul>
<li><a href="https://www.zabbix.com/documentation/3.4/manual/appendix/items/activepassive" class="uri">https://www.zabbix.com/documentation/3.4/manual/appendix/items/activepassive</a></li>
<li><a href="https://www.zabbix.com/documentation/3.4/manual/appendix/protocols/header_datalen" class="uri">https://www.zabbix.com/documentation/3.4/manual/appendix/protocols/header_datalen</a></li>
</ul>
</article>

<div id="footer">
  <span class="copyrights">© 2018-2019 C. Boyer, contenu sous licence <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.fr">Creative Commons BY-SA-NC 4.0</a>, l'ensemble des codes sources sont sous licence <a href="https://www.gnu.org/licenses/gpl-3.0.fr.html">GNU GPL v3</a>.</span>
</div>

</div>
</body>
</html>
