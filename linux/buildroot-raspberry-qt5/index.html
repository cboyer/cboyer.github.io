<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Interface graphique avec Buildroot, Qt5 et Raspberry Pi 3 - C.
Boyer</title>
  <meta name="description" content="Développement d'une interface
graphique Qt5/QML sur Raspberry Pi 3 avec Buildroot." />
  <meta name="author" content="C. Boyer" />
  <meta name="keywords" content="Buildroot, Qt5, QML, Raspberry, Linux, EGL, OpenGLES, eglfs, eglfs_brcm, eglfs_kms" />
  <meta name="robots" content="index,follow">
  <link rel="icon" href="data:;base64,iVBORw0KGgo=">
  <link href="https://cboyer.github.io/atom.xml" rel="alternate" type="application/atom+xml" title="Flux RSS" />
  <style>
    body { margin: 1em; }
    img { max-width: 100%; height: auto; }
    table { margin-top: 1em; font-size: 11px; }
    @media (min-width: 42em) { body { margin: 1em auto; max-width: 45em; } }
    ul { list-style: none; padding: 0;}
    p code { font-size: 1.1em; }
    blockquote {margin: 0; }
    figure { text-align: center; font-style: italic; }
    pre { background-color: whitesmoke; overflow: auto; }
    .sourceCode { overflow: auto !important; }
  </style>
  <style>pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    background-color: #ffffff;
    color: #a0a0a0;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #a0a0a0;  padding-left: 4px; }
div.sourceCode
  { color: #1f1c1b; background-color: #ffffff; }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span { color: #1f1c1b; } /* Normal */
code span.al { color: #bf0303; background-color: #f7e6e6; font-weight: bold; } /* Alert */
code span.an { color: #ca60ca; } /* Annotation */
code span.at { color: #0057ae; } /* Attribute */
code span.bn { color: #b08000; } /* BaseN */
code span.bu { color: #644a9b; font-weight: bold; } /* BuiltIn */
code span.cf { color: #1f1c1b; font-weight: bold; } /* ControlFlow */
code span.ch { color: #924c9d; } /* Char */
code span.cn { color: #aa5500; } /* Constant */
code span.co { color: #898887; } /* Comment */
code span.cv { color: #0095ff; } /* CommentVar */
code span.do { color: #607880; } /* Documentation */
code span.dt { color: #0057ae; } /* DataType */
code span.dv { color: #b08000; } /* DecVal */
code span.er { color: #bf0303; text-decoration: underline; } /* Error */
code span.ex { color: #0095ff; font-weight: bold; } /* Extension */
code span.fl { color: #b08000; } /* Float */
code span.fu { color: #644a9b; } /* Function */
code span.im { color: #ff5500; } /* Import */
code span.in { color: #b08000; } /* Information */
code span.kw { color: #1f1c1b; font-weight: bold; } /* Keyword */
code span.op { color: #1f1c1b; } /* Operator */
code span.ot { color: #006e28; } /* Other */
code span.pp { color: #006e28; } /* Preprocessor */
code span.re { color: #0057ae; background-color: #e0e9f8; } /* RegionMarker */
code span.sc { color: #3daee9; } /* SpecialChar */
code span.ss { color: #ff5500; } /* SpecialString */
code span.st { color: #bf0303; } /* String */
code span.va { color: #0057ae; } /* Variable */
code span.vs { color: #bf0303; } /* VerbatimString */
code span.wa { color: #bf0303; } /* Warning */</style>
</head>
<body>
  <h1>Interface graphique avec Buildroot, Qt5 et Raspberry Pi 3</h1>
  <em>Publié le 2021-07-22, dernière mise à jour: 2021-07-23</em>
<p>L'article a été rédigé en utilisant un Raspberry Pi 3 avec Buildroot
2021.05-514-g74adec4f3a qui contient Qt5 5.15.2 et un noyau 5.10. Le
Raspberry est connecté à un télévieur via HDMI. L'objectif est d'obtenir
un système minimaliste Linux sans serveur X permettant d'exécuter une
application graphique tout en bénéficiant de l'accélération
matérielle.</p>
<ul>
<li><a href="#eglfs_brcm">Utiliser eglfs_brcm comme backend</a></li>
<li><a href="#eglfs_kms">Utiliser eglfs_kms comme backend au lieu de
eglfs_brcm</a></li>
</ul>
<h2
id="utiliser-eglfs_brcm-comme-backend"><a name="eglfs_brcm"></a>Utiliser
eglfs_brcm comme backend</h2>
<p>Le backend <code>eglfs_brcm</code> repose sur les pilotes graphiques
propriétaires Broadcom afin de fournir un support pour OpenGLES/EGL avec
les fichiers <code>/usr/lib/libbrcmEGL.so</code> et
<code>/usr/lib/libbrcmGLESv2.so</code>. Ceux-ci sont fournis par le
package <code>Rpi-userland</code> et les "Firmware Driver" dans le
noyau.</p>
<h3 id="configuration-buildroot">Configuration Buildroot</h3>
<pre class="console"><code>make raspberrypi3_defconfig
make menuconfig</code></pre>
<pre class="text"><code>System configuration
├─ System hostname (BR2_TARGET_GENERIC_HOSTNAME=&quot;buildrootqt5&quot;)
├─ Root password (BR2_TARGET_GENERIC_ROOT_PASSWD=&quot;root&quot;)
├─ remount root filesystem read-write during boot (BR2_TARGET_GENERIC_REMOUNT_ROOTFS_RW=n)
└─ Root filesystem overlay directories (BR2_ROOTFS_OVERLAY=output/rootfs_overlay)

Toolchain
└─ Enable WCHAR support (BR2_TOOLCHAIN_BUILDROOT_WCHAR=y)

Target packages
├─ Hardware handling
|  └─ rpi-userland (BR2_PACKAGE_RPI_USERLAND=y)
|
└─ Graphic libraries and applications (graphic/text)
   └─ Qt5 (BR2_PACKAGE_QT5=y)
      ├─ Custom configuration options (BR2_PACKAGE_QT5BASE_CUSTOM_CONF_OPTS 
      |  [=-skip qtconnectivity -skip qtnetwork -skip qtgamepad -no-feature-vnc -no-feature-accessibility -nomake tests])
      ├─ eglfs support (BR2_PACKAGE_QT5BASE_EGLFS=y)
      └─ Default graphical platform (BR2_PACKAGE_QT5BASE_DEFAULT_QPA=&quot;eglfs&quot;)</code></pre>
<p>Peuvent être désactivés:</p>
<pre class="text"><code>Target packages
├─ Graphic libraries and applications (graphic/text) → mesa3d (BR2_PACKAGE_MESA3D=n)
└─ Libraries
   └─ Graphics
      └─ libdrm (BR2_PACKAGE_LIBDRM=n)</code></pre>
<p>Les librairies C <code>uClibc-ng</code> et <code>glibc</code>
fonctionnent avec ces modules Qt5 (<code>musl</code> n'a pas été testée)
cependant certains packages comme <code>qt5webengine</code> nécessitent
<code>glibc</code>. D'autres packages comme
<code>qt5quickcontrols2</code>, <code>qt5graphicaleffects</code> et
<code>qt5wayland</code> peuvent être ajoutés selon les besoins
applicatifs (ce qui n'est pas le cas pour notre application de
test).</p>
<p>Les options de compilation pour Qt peuvent être modifiées selon les
besoins. Exemple: <em>-skip qtconnectivity -skip qtdoc -skip
qtandroidextras -skip qtnetworkauth -skip qtpurchasing -skip qtgamepad
-no-feature-vnc -no-feature-accessibility -no-feature udpsocket
-no-feature-networkproxy -no-feature-socks5 -no-feature-networkdiskcache
-no-feature-testlib -nomake tests</em>.</p>
<p>Sauvegarde de la configuration Buildroot:</p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> savedefconfig BR2_DEFCONFIG=./buildrootqt5.config</span></code></pre></div>
<h3 id="configuration-du-noyau-linux">Configuration du noyau Linux</h3>
<p>Pour la configuration du noyau, aucun pilote graphique particulier
(DRM, VC4) n'est nécessaire, il faut veiller à la présence des "Firmware
Driver" (présents par défaut):</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> linux-menuconfig</span></code></pre></div>
<pre class="text"><code>Firmware Drivers
└─ Raspberry Pi Firmware Driver (RASPBERRYPI_FIRMWARE=y)

Device Drivers
└─ Graphics support
   └─ Direct Rendering Manager (XFree86 4.1.0 and higher DRI support) (DRM=n)</code></pre>
<p>Sauvegarde de la configuration du noyau:</p>
<pre class="console"><code>cp output/build/linux-custom/.config linux.config</code></pre>
<h3 id="overlay">Overlay</h3>
<p>Pour inclure nos fichiers nous allons utiliser un overlay, tous les
fichiers contenu dans <code>output/rootfs_overlay</code> (considéré par
Buildroot comme référence à la racine) seront présents dans l'image
finale.</p>
<p><code>output/rootfs_overlay/usr/share/fonts/dejavu-sans-webfont.ttf</code>:
Qt5 ne fournit plus de police de caractères, il faut au minimum une
police TTF sur le système. Buildroot peut également inclure des polices
avec:</p>
<pre class="text"><code>Target packages
└─ Fonts, cursors, icons, sounds and themes
   └─ DejaVu fonts (BR2_PACKAGE_DEJAVU)</code></pre>
<p><code>output/rootfs_overlay/root/test.sh</code>: script de lancement
de l'application QML <code>box.qml</code>.</p>
<div class="sourceCode" id="cb9"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/sh</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">QT_QPA_PLATFORM</span><span class="op">=</span>eglfs</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">QT_QPA_EGLFS_INTEGRATION</span><span class="op">=</span>eglfs_brcm</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">QT_QPA_EGLFS_ALWAYS_SET_MODE</span><span class="op">=</span>1</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">QT_XKB_CONFIG_ROOT</span><span class="op">=</span>/tmp</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="co">#Backends Qt5 disponibles, à titre indicatif</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">QT_QPA_PLATFORM_PLUGIN_PATH</span><span class="op">=</span>/usr/lib/qt/plugins/platforms</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="co">#Dossier des polices TTF</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">QT_QPA_FONTDIR</span><span class="op">=</span>/usr/share/fonts</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a><span class="co">#Active le clavier dans le terminal en arrière plan (permet notamment le CTRL+C)</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">QT_QPA_ENABLE_TERMINAL_KEYBOARD</span><span class="op">=</span>1</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a><span class="co">#Cache le curseur de la souris</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">QT_QPA_EGLFS_HIDECURSOR</span><span class="op">=</span>1</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a><span class="ex">qmlscene</span> box.qml <span class="at">-platform</span> eglfs</span></code></pre></div>
<blockquote>
<p>Il n'est pas necéssaire d'utiliser
<code>export LD_LIBRARY_PATH=/opt/vc/lib/:$LD_LIBRARY_PATH</code> car le
package Rpi-userland place les librairies dans <code>/usr/lib</code> au
lieu de <code>/opt/vc/lib</code>.</p>
</blockquote>
<p><code>output/rootfs_overlay/root/box.qml</code>: l'application QML de
test qui sera exécutée avec <code>qmlscene</code>. Il s'agit d'une boîte
rouge déplaçable avec les flềches du clavier et les cliques d'une
souris.</p>
<div class="sourceCode" id="cb10"><pre
class="sourceCode qml"><code class="sourceCode qml"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span><span class="im"> QtQuick 2.0</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="ot">Item</span> {</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">width</span><span class="op">:</span> <span class="dv">800</span><span class="op">;</span> <span class="dt">height</span><span class="op">:</span> <span class="dv">600</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">focus</span><span class="op">:</span> <span class="kw">true</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    <span class="ex">Keys</span><span class="op">.</span><span class="at">onPressed</span><span class="op">:</span> {</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (event<span class="op">.</span><span class="at">key</span> <span class="op">==</span> <span class="ex">Qt</span><span class="op">.</span><span class="at">Key_Enter</span>) {</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>            rect<span class="op">.</span><span class="at">x</span> <span class="op">=</span> <span class="dv">600</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>            rect<span class="op">.</span><span class="at">y</span> <span class="op">=</span> <span class="dv">400</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (event<span class="op">.</span><span class="at">key</span> <span class="op">==</span> <span class="ex">Qt</span><span class="op">.</span><span class="at">Key_Space</span>) {</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>            rect<span class="op">.</span><span class="at">x</span> <span class="op">=</span> <span class="dv">50</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>            rect<span class="op">.</span><span class="at">y</span> <span class="op">=</span> <span class="dv">50</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (event<span class="op">.</span><span class="at">key</span> <span class="op">==</span> <span class="ex">Qt</span><span class="op">.</span><span class="at">Key_Left</span>) {</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>            rect<span class="op">.</span><span class="at">x</span> <span class="op">=</span> rect<span class="op">.</span><span class="at">x</span> <span class="op">-</span> <span class="dv">50</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (event<span class="op">.</span><span class="at">key</span> <span class="op">==</span> <span class="ex">Qt</span><span class="op">.</span><span class="at">Key_Right</span>) {</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>            rect<span class="op">.</span><span class="at">x</span> <span class="op">=</span> rect<span class="op">.</span><span class="at">x</span> <span class="op">+</span> <span class="dv">50</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (event<span class="op">.</span><span class="at">key</span> <span class="op">==</span> <span class="ex">Qt</span><span class="op">.</span><span class="at">Key_Down</span>) {</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>            rect<span class="op">.</span><span class="at">y</span> <span class="op">=</span> rect<span class="op">.</span><span class="at">y</span> <span class="op">+</span> <span class="dv">50</span></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (event<span class="op">.</span><span class="at">key</span> <span class="op">==</span> <span class="ex">Qt</span><span class="op">.</span><span class="at">Key_Up</span>) {</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>            rect<span class="op">.</span><span class="at">y</span> <span class="op">=</span> rect<span class="op">.</span><span class="at">y</span> <span class="op">-</span> <span class="dv">50</span></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>    <span class="ot">Rectangle</span> {</span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>        anchors<span class="op">.</span><span class="at">fill</span><span class="op">:</span> parent</span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>        <span class="dt">color</span><span class="op">:</span> <span class="st">&quot;black&quot;</span></span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>    <span class="ot">Rectangle</span> {</span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>        <span class="dt">id</span><span class="op">:</span> rect</span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>        <span class="dt">width</span><span class="op">:</span> <span class="dv">100</span><span class="op">;</span> <span class="dt">height</span><span class="op">:</span> <span class="dv">100</span></span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>        <span class="dt">color</span><span class="op">:</span> <span class="st">&quot;red&quot;</span></span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>        <span class="ot">Behavior</span> on x { <span class="ot">PropertyAnimation</span> { <span class="dt">duration</span><span class="op">:</span> <span class="dv">500</span> } }</span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>        <span class="ot">Behavior</span> on y { <span class="ot">PropertyAnimation</span> { <span class="dt">duration</span><span class="op">:</span> <span class="dv">500</span> } }</span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>        <span class="ot">Text</span> {</span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>            <span class="dt">text</span><span class="op">:</span> <span class="st">&quot;Hello</span><span class="sc">\n</span><span class="st">world!&quot;</span></span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>            font<span class="op">.</span><span class="at">pointSize</span><span class="op">:</span> <span class="dv">24</span><span class="op">;</span> font<span class="op">.</span><span class="at">bold</span><span class="op">:</span> <span class="kw">true</span></span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a>    <span class="ot">MouseArea</span> {</span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a>        anchors<span class="op">.</span><span class="at">fill</span><span class="op">:</span> parent</span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a>        <span class="dt">onClicked</span><span class="op">:</span> { rect<span class="op">.</span><span class="at">x</span> <span class="op">=</span> mouse<span class="op">.</span><span class="at">x</span><span class="op">;</span> rect<span class="op">.</span><span class="at">y</span> <span class="op">=</span> mouse<span class="op">.</span><span class="at">y</span><span class="op">;</span> }</span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<blockquote>
<p>Si la résolution est supérieur à 800x600 pixels, l'application
utilisera l'ensemble de l'espace disponible sans tenir compte des
dimmensions <code>width: 800; height: 600</code>.</p>
</blockquote>
<h3 id="compilation">Compilation</h3>
<p>Lancer la compilation et la création de l'image:</p>
<pre class="console"><code>make</code></pre>
<p>Pour vérifier les options de compilation du package
<code>qt5base</code>, notamment les backends disponibles:</p>
<pre class="console"><code>cat ./output/build/qt5base-5.15.2/config.summary</code></pre>
<pre class="text"><code>QPA backends:
  DirectFB ............................... no
  EGLFS .................................. yes
  EGLFS details:
    EGLFS OpenWFD ........................ no
    EGLFS i.Mx6 .......................... no
    EGLFS i.Mx6 Wayland .................. no
    EGLFS RCAR ........................... no
    EGLFS EGLDevice ...................... no
    EGLFS GBM ............................ no
    EGLFS VSP2 ........................... no
    EGLFS Mali ........................... no
    EGLFS Raspberry Pi ................... yes
    EGLFS X11 ............................ no
  LinuxFB ................................ no
  VNC .................................... no</code></pre>
<p>Copie de l'image générée vers la carte SD:</p>
<pre class="console"><code>sudo dd if=output/images/sdcard.img of=/dev/mmcblk0 status=progress</code></pre>
<p>Après démarrer le système sur le Raspberry, exécuter
<code>test.sh</code>:</p>
<pre class="console"><code>sh test.sh</code></pre>
<h2
id="utiliser-eglfs_kms-comme-backend-au-lieu-de-eglfs_brcm"><a name="eglfs_kms"></a>Utiliser
eglfs_kms comme backend au lieu de eglfs_brcm</h2>
<p>Au lieu d'utiliser le pilote propriétaire Broadcom, nous allons
utiliser le backend OpenGLES libre fourni avec Mesa3d ainsi que le
pilote VC4.</p>
<h3 id="configuration-buildroot-1">Configuration Buildroot</h3>
<div class="sourceCode" id="cb16"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> raspberrypi3_defconfig</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> menuconfig</span></code></pre></div>
<pre class="text"><code>System configuration
├─ System hostname (BR2_TARGET_GENERIC_HOSTNAME=&quot;buildrootqt5&quot;)
├─ Root password (BR2_TARGET_GENERIC_ROOT_PASSWD=&quot;root&quot;)
├─ remount root filesystem read-write during boot (BR2_TARGET_GENERIC_REMOUNT_ROOTFS_RW=n)
├─ Root filesystem overlay directories (BR2_ROOTFS_OVERLAY=output/rootfs_overlay)
├─ Custom scripts to run before creating filesystem images 
|  (BR2_ROOTFS_POST_BUILD_SCRIPT=board/raspberrypi3/post-build.sh output/post-build-config.sh)
└─ /dev management (Dynamic using devtmpfs + eudev) (BR2_ROOTFS_DEVICE_CREATION_DYNAMIC_EUDEV=y)

Toolchain
└─ Enable WCHAR support (BR2_TOOLCHAIN_BUILDROOT_WCHAR=y)

Target packages
├─ Libraries
|  └─ Graphics
|     └─ libdrm (BR2_PACKAGE_LIBDRM=y)
|        └─ vc4 (BR2_PACKAGE_LIBDRM_VC4=y)
└─ Graphic libraries and applications (graphic/text)
   ├─ mesa3d (BR2_PACKAGE_MESA3D=y)
   |  ├─ Gallium vc4 driver (BR2_PACKAGE_MESA3D_GALLIUM_DRIVER_VC4=y)
   |  └─ OpenGL ES (BR2_PACKAGE_MESA3D_OPENGL_ES=y)
   └─ Qt5 (BR2_PACKAGE_QT5=y)
      ├─ Custom configuration options (BR2_PACKAGE_QT5BASE_CUSTOM_CONF_OPTS
      |  [=-skip qtconnectivity -skip qtnetwork -skip qtgamepad -no-feature-vnc -no-feature-accessibility -nomake tests])
      ├─ eglfs support (BR2_PACKAGE_QT5BASE_EGLFS=y)
      └─ Default graphical platform (BR2_PACKAGE_QT5BASE_DEFAULT_QPA=&quot;eglfs&quot;)</code></pre>
<p>Les packages <em>mesa3d → OpenGL ES
(BR2_PACKAGE_MESA3D_OPENGL_ES=y)</em> et <em>rpi-userland
(BR2_PACKAGE_RPI_USERLAND=y)</em> ne peuvent cohabiter pour fournir un
support OpenGLES.</p>
<p>Nous utiliserons un script post-build
<code>output/post-build-config.sh</code> en plus de celui par défaut
<code>board/raspberrypi3/post-build.sh</code>. Ils doivent être séparés
par un espace.</p>
<p>L'utilisation de udev (eudev) est util pour la détection automatique
des périphériques et charger les modules requis ce qui permettra de
rendre disponible le GPU dans <code>/dev/dri/card0</code>. Il est
possible de se passer de udev en chargeant les modules requis
manuellement (cas exposé plus tard).</p>
<p>Pas besoin d'inclure mesa3d → Gallium v3d driver.</p>
<p>Sauvegarde de la configuration Buildroot:</p>
<pre class="console"><code>make savedefconfig BR2_DEFCONFIG=./buildrootqt5_vc4.config</code></pre>
<h3 id="configuration-du-noyau-linux-1">Configuration du noyau
Linux</h3>
<p>Pour la configuration du noyau, il faut inclure le pilote VC4:</p>
<pre class="console"><code>make linux-menuconfig</code></pre>
<pre class="text"><code>Device Drivers
└─ Graphics support
   ├─ Direct Rendering Manager (XFree86 4.1.0 and higher DRI support) (CONFIG_DRM=y)
   └─ Broadcom VC4 Graphics (CONFIG_DRM_VC4=m)</code></pre>
<blockquote>
<p>Pas besoin d'inclure <em>Device Drivers → Graphics support → Broadcom
V3D 3.x and newer (CONFIG_DRM_V3D)</em></p>
</blockquote>
<p>Sauvegarde de la configuration du noyau:</p>
<pre class="console"><code>cp output/build/linux-custom/.config linux_vc4.config</code></pre>
<h3 id="overlay-1">Overlay</h3>
<p>Le contenu de l'overlay <code>output/rootfs_overlay</code> reste le
même sauf pour le script <code>output/rootfs_overlay/root/test.sh</code>
qui intègre une valeur différente pour
<code>QT_QPA_EGLFS_INTEGRATION</code> et une nouvelle variable
<code>QT_QPA_EGLFS_NO_LIBINPUT</code>:</p>
<div class="sourceCode" id="cb22"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/sh</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">QT_QPA_PLATFORM</span><span class="op">=</span>eglfs</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">QT_QPA_EGLFS_INTEGRATION</span><span class="op">=</span>eglfs_kms</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">QT_QPA_EGLFS_ALWAYS_SET_MODE</span><span class="op">=</span>1</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">QT_XKB_CONFIG_ROOT</span><span class="op">=</span>/tmp</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="co">#Backends Qt5 disponibles, à titre indicatif</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">QT_QPA_PLATFORM_PLUGIN_PATH</span><span class="op">=</span>/usr/lib/qt/plugins/platforms</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a><span class="co">#Dossier des polices TTF</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">QT_QPA_FONTDIR</span><span class="op">=</span>/usr/share/fonts</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a><span class="co">#Active le clavier dans le terminal en arrière plan (permet notamment le CTRL+C)</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">QT_QPA_ENABLE_TERMINAL_KEYBOARD</span><span class="op">=</span>1</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a><span class="co">#Désactive Libinput, corrige le problème de clavier non fonctionnel</span></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">QT_QPA_EGLFS_NO_LIBINPUT</span><span class="op">=</span>1</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a><span class="co">#Cache le curseur de la souris</span></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">QT_QPA_EGLFS_HIDECURSOR</span><span class="op">=</span>1</span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a><span class="ex">qmlscene</span> box.qml <span class="at">-platform</span> eglfs</span></code></pre></div>
<blockquote>
<p>Avec l'ajout de udev, Qt5 utilise son composant evdev qui nécessite
la désactivation de Libinput avec
<code>QT_QPA_EGLFS_NO_LIBINPUT=1</code>.</p>
</blockquote>
<h3 id="script-post-build">Script post-build</h3>
<p>Le chargement du pilote VC4 au démarrage nécessite l'ajout des
directives <code>gpu_mem=128</code> et
<code>dtoverlay=vc4-kms-v3d</code> dans le fichier
<code>config.txt</code> de la partition de boot. Pour cela nous
utiliserons un script post-build <code>post-build-config.sh</code> dans
le dossier <code>output/</code> (déjà configuré dans Buildroot).</p>
<p>post-build-config.sh:</p>
<div class="sourceCode" id="cb23"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/sh</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="bu">set</span> <span class="at">-u</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="bu">set</span> <span class="at">-e</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="ot">! </span><span class="fu">grep</span> <span class="at">-qE</span> <span class="st">&#39;^gpu_mem=128&#39;</span> <span class="st">&quot;</span><span class="va">${BINARIES_DIR}</span><span class="st">/rpi-firmware/config.txt&quot;</span>  <span class="kw">&amp;&amp;</span> <span class="ot">! </span><span class="fu">grep</span> <span class="at">-qE</span> <span class="st">&#39;^dtoverlay=vc4-kms-v3d&#39;</span> <span class="st">&quot;</span><span class="va">${BINARIES_DIR}</span><span class="st">/rpi-firmware/config.txt&quot;</span><span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">&quot;Adding &#39;gpu_mem=128&#39; and &#39;dtoverlay=vc4-kms-v3d&#39; to config.txt (load VC4).&quot;</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">&quot;gpu_mem=128&quot;</span> <span class="op">&gt;&gt;</span> <span class="st">&quot;</span><span class="va">${BINARIES_DIR}</span><span class="st">/rpi-firmware/config.txt&quot;</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">&quot;dtoverlay=vc4-kms-v3d&quot;</span> <span class="op">&gt;&gt;</span> <span class="st">&quot;</span><span class="va">${BINARIES_DIR}</span><span class="st">/rpi-firmware/config.txt&quot;</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a><span class="cf">fi</span></span></code></pre></div>
<p>Ne pas oublier de donner les droits d'exécution avec
<code>chmod +x output/post-build-config.sh</code>.</p>
<h3 id="compilation-1">Compilation</h3>
<p>Lancer la compilation et la création de l'image:</p>
<pre class="console"><code>make</code></pre>
<p>Pour vérifier les options de compilation du package
<code>qt5base</code>, notamment les backends disponibles:</p>
<pre class="console"><code>cat ./output/build/qt5base-5.15.2/config.summary</code></pre>
<pre class="text"><code>QPA backends:
  DirectFB ............................... no
  EGLFS .................................. yes
  EGLFS details:
    EGLFS OpenWFD ........................ no
    EGLFS i.Mx6 .......................... no
    EGLFS i.Mx6 Wayland .................. no
    EGLFS RCAR ........................... no
    EGLFS EGLDevice ...................... yes
    EGLFS GBM ............................ yes
    EGLFS VSP2 ........................... no
    EGLFS Mali ........................... no
    EGLFS Raspberry Pi ................... no
    EGLFS X11 ............................ no
  LinuxFB ................................ no
  VNC .................................... no</code></pre>
<p>Copie de l'image générée vers la carte SD:</p>
<pre class="console"><code>sudo dd if=output/images/sdcard.img of=/dev/mmcblk0 status=progress</code></pre>
<p>Après démarrer le système sur le Raspberry, exécuter
<code>test.sh</code> pour lancer l'application QML:</p>
<pre class="console"><code>sh test.sh</code></pre>
<h3 id="se-passer-de-udev-eudev">Se passer de udev (eudev)</h3>
<p>Il est possible de ne pas inclure udev (dans Buildroot: <em>System
configuration → /dev management</em>). Les modules chargés
automatiquement par udev (liste récupérée avec <code>lsmod</code>):</p>
<pre class="text"><code>Module                  Size  Used by    Tainted: G  
snd_soc_hdmi_codec     20480  1 
brcmfmac              327680  0 
brcmutil               24576  1 brcmfmac
sha256_generic         16384  0 
libsha256              20480  1 sha256_generic
vc4                   249856  2 
snd_soc_core          229376  2 snd_soc_hdmi_codec,vc4
snd_compress           20480  1 snd_soc_core
cfg80211              782336  1 brcmfmac
snd_pcm_dmaengine      16384  1 snd_soc_core
snd_pcm               114688  4 snd_soc_hdmi_codec,snd_soc_core,snd_compress,snd_pcm_dmaengine
snd_timer              36864  1 snd_pcm
snd                    77824  5 snd_soc_hdmi_codec,snd_soc_core,snd_compress,snd_pcm,snd_timer
raspberrypi_hwmon      16384  0 
i2c_bcm2835            16384  0 
vc_sm_cma              32768  0 
uio_pdrv_genirq        16384  0 
uio                    20480  1 uio_pdrv_genirq
fixed                  16384  0 </code></pre>
<p>Pour se passer de udev et obtenir <code>/dev/dri/card0</code>,
certains modules doivent être chargés (via un script ou manuellement)
avec <code>modprobe</code>:</p>
<div class="sourceCode" id="cb30"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/sh</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="ex">modprobe</span> snd_soc_hdmi_codec</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="ex">modprobe</span> i2c_bcm2835</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="ex">modprobe</span> vc4</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="ex">modprobe</span> vc_sm_cma</span></code></pre></div>
<p>Résultat dans <code>dmesg</code>:</p>
<pre class="text"><code>[   40.318528] fb0: switching to vc4drmfb from simple
[   40.325374] Console: switching to colour dummy device 80x30
[   40.662845] vc4-drm soc:gpu: bound 3f400000.hvs (ops vc4_hvs_ops [vc4])
[   40.677294] vc4-drm soc:gpu: bound 3f902000.hdmi (ops vc4_hdmi_ops [vc4])
[   40.684485] vc4-drm soc:gpu: bound 3f806000.vec (ops vc4_vec_ops [vc4])
[   40.691473] vc4-drm soc:gpu: bound 3f004000.txp (ops vc4_txp_ops [vc4])
[   40.698433] vc4-drm soc:gpu: bound 3f206000.pixelvalve (ops vc4_crtc_ops [vc4])
[   40.706101] vc4-drm soc:gpu: bound 3f207000.pixelvalve (ops vc4_crtc_ops [vc4])
[   40.713734] vc4-drm soc:gpu: bound 3f807000.pixelvalve (ops vc4_crtc_ops [vc4])
[   40.721306] vc4-drm soc:gpu: bound 3fc00000.v3d (ops vc4_v3d_ops [vc4])
[   40.731228] [drm] Initialized vc4 0.0.0 20140616 for soc:gpu on minor 0
[   40.881762] Console: switching to colour frame buffer device 240x67
[   40.921477] vc4-drm soc:gpu: [drm] fb0: vc4drmfb frame buffer device
[   41.002400] vc_sm_cma: module is from the staging directory, the quality is unknown, you have been warned.
[   41.014768] bcm2835_vc_sm_cma_probe: Videocore shared memory driver
[   41.021175] [vc_sm_connected_init]: start
[   41.026489] [vc_sm_connected_init]: installed successfully</code></pre>
<h2 id="liens-complémentaires">Liens complémentaires</h2>
<ul>
<li><a
href="https://buildroot.org/downloads/manual/manual.html">https://buildroot.org/downloads/manual/manual.html</a></li>
<li><a
href="https://doc.qt.io/qt-5/inputs-linux-device.html">https://doc.qt.io/qt-5/inputs-linux-device.html</a></li>
<li><a
href="https://doc.qt.io/archives/qt-5.6/embedded-linux.html">https://doc.qt.io/archives/qt-5.6/embedded-linux.html</a></li>
<li><a
href="https://doc.qt.io/qt-5/qtquickcontrols-index.html#versions">https://doc.qt.io/qt-5/qtquickcontrols-index.html#versions</a></li>
<li><a
href="https://doc.qt.io/qt-5/configure-options.html">https://doc.qt.io/qt-5/configure-options.html</a></li>
</ul>
  <br />
  <hr />
  <em>©2015-2024 C. Boyer, contenu sous licence <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.fr">CC BY-SA-NC 4.0</a>, codes sources sous <a href="https://www.gnu.org/licenses/gpl-3.0.fr.html">GNU GPL v3</a></em>
</body>
</html>
