<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Système embarqué Linux avec Buildroot - C. Boyer</title>
  <meta name="description" content="Création d’un système embarqué Linux avec Buildroot pour Raspberry Pi 2." />
  <meta name="author" content="C. Boyer" />
  <meta name="keywords" content="buildroot, embarqué, raspberry pi, linux" />
  <meta property="og:title" content="Système embarqué Linux avec Buildroot" />
  <meta property="og:locale" content="fr_CA" />
  <meta property="og:description" content="Création d’un système embarqué Linux avec Buildroot pour Raspberry Pi 2." />
  <meta property="og:site_name" content="cboyer.github.io" />
  <meta property="og:type" content="article" />
  <meta property="article:published_time" content="2018-08-09T11:29:00-04:00" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="generator" content="pandoc" />
  <link href="https://cboyer.github.io/atom.xml" rel="alternate" type="application/atom+xml" />
  <link rel="stylesheet" type="text/css" href="../../style.css" />

  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; position: absolute; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; }
pre.numberSource a.sourceLine:empty
  { position: absolute; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: absolute; left: -5em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    background-color: #ffffff;
    color: #a0a0a0;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #a0a0a0;  padding-left: 4px; }
div.sourceCode
  { color: #1f1c1b; background-color: #ffffff; }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span. { color: #1f1c1b; } /* Normal */
code span.al { color: #bf0303; background-color: #f7e6e6; font-weight: bold; } /* Alert */
code span.an { color: #ca60ca; } /* Annotation */
code span.at { color: #0057ae; } /* Attribute */
code span.bn { color: #b08000; } /* BaseN */
code span.bu { color: #644a9b; font-weight: bold; } /* BuiltIn */
code span.cf { color: #1f1c1b; font-weight: bold; } /* ControlFlow */
code span.ch { color: #924c9d; } /* Char */
code span.cn { color: #aa5500; } /* Constant */
code span.co { color: #898887; } /* Comment */
code span.cv { color: #0095ff; } /* CommentVar */
code span.do { color: #607880; } /* Documentation */
code span.dt { color: #0057ae; } /* DataType */
code span.dv { color: #b08000; } /* DecVal */
code span.er { color: #bf0303; text-decoration: underline; } /* Error */
code span.ex { color: #0095ff; font-weight: bold; } /* Extension */
code span.fl { color: #b08000; } /* Float */
code span.fu { color: #644a9b; } /* Function */
code span.im { color: #ff5500; } /* Import */
code span.in { color: #b08000; } /* Information */
code span.kw { color: #1f1c1b; font-weight: bold; } /* Keyword */
code span.op { color: #1f1c1b; } /* Operator */
code span.ot { color: #006e28; } /* Other */
code span.pp { color: #006e28; } /* Preprocessor */
code span.re { color: #0057ae; background-color: #e0e9f8; } /* RegionMarker */
code span.sc { color: #3daee9; } /* SpecialChar */
code span.ss { color: #ff5500; } /* SpecialString */
code span.st { color: #bf0303; } /* String */
code span.va { color: #0057ae; } /* Variable */
code span.vs { color: #bf0303; } /* VerbatimString */
code span.wa { color: #bf0303; } /* Warning */
  </style>
</head>
<body>
  <div id="container">
    <div id="links">
      <a href="../../rechercher.html" class="search" title="Rechercher">
          <svg class="button" aria-labelledby="search-icon" role="img" viewBox="5 5 21 21" xmlns="http://www.w3.org/2000/svg">
            <title id="search-icon">Rechercher</title>
            <path d="M27 24.57l-5.647-5.648a8.895 8.895 0 0 0 1.522-4.984C22.875 9.01 18.867 5 13.938 5 9.01 5 5 9.01 5 13.938c0 4.929 4.01 8.938 8.938 8.938a8.887 8.887 0 0 0 4.984-1.522L24.568 27 27 24.57zm-13.062-4.445a6.194 6.194 0 0 1-6.188-6.188 6.195 6.195 0 0 1 6.188-6.188 6.195 6.195 0 0 1 6.188 6.188 6.195 6.195 0 0 1-6.188 6.188z"/>
          </svg>
      </a>
      <a href="https://github.com/cboyer" class="github" title="GitHub" target="_blank">
          <svg class="button" aria-labelledby="github-icon" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <title id="github-icon">GitHub</title>
            <path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"></path>
          </svg>
      </a>
      <a href="../../atom.xml" class="rss" title="Flux Atom">
          <svg class="button" aria-labelledby="atom-icon" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <title id="atom-icon">Flux Atom</title>
            <path d="M19.199 24C19.199 13.467 10.533 4.8 0 4.8V0c13.165 0 24 10.835 24 24h-4.801zM3.291 17.415c1.814 0 3.293 1.479 3.293 3.295 0 1.813-1.485 3.29-3.301 3.29C1.47 24 0 22.526 0 20.71s1.475-3.294 3.291-3.295zM15.909 24h-4.665c0-6.169-5.075-11.245-11.244-11.245V8.09c8.727 0 15.909 7.184 15.909 15.91z"></path>
          </svg>
      </a>
    </div>

    <h1>cboyer.github.io</h1>

    <ul class="menu">
      <li class="menu_item"><a href="../../index.html">Publications</a></li>
      <li class="menu_item active"><a href="../../linux.html">Linux</a></li>
      <li class="menu_item"><a href="../../electronique.html">Électronique</a></li>
      <li class="menu_item"><a href="../../apropos.html">À propos</a></li>
    </ul>

<article>
<header id="title-block-header">
<h2 class="title">Système embarqué Linux avec Buildroot</h1>
 <span class="author">C. Boyer</span>,   <span class="date">2018-08-09 11:29:00 (UTC-04:00)</span>
</header>
<p>Dans le cadre d’un projet de monitoring, j’ai été amené à concevoir une vingtaine de sondes thermiques pouvant être interrogées via Ethernet. Mes choix techniques se sont naturellement tournés vers une solution Raspberry Pi/Linux/capteur DS18B20. Pour le coté applicatif j’ai opté pour la simplicité et la rapidité avec le couple Python/Flask pour acheminer les données via HTTPS. L’applicatif aurait pu être développé en C avec des librairies comme <a href="https://www.gnu.org/software/libmicrohttpd/">Libmicrohttpd</a> ou encore <a href="https://kore.io/">Kore</a>.</p>
<p>Le ciment permettant de lier l’ensemble est <a href="https://buildroot.org/">Buildroot</a> qui va nous permettre d’obtenir un système Linux sur mesure. Buildroot est un outil permettant de générer des systèmes Linux sur mesure en prenant en charge la compilation de la toolchain pour l’architecture cible (ARMv7), du noyau, du bootloader (que nous n’utiliserons pas) et de BusyBox pour l’environnement utilisateur. Tout cela avec nos paramètres définis pour chaque élément: modules dans le noyau, librairies standards (<a href="http://www.etalabs.net/compare_libcs.html">musl</a>, glibc, etc.), gestionnaire de services/périphériques (initd, systemd, udev), binaires à inclure dans BusyBoxy, etc. L’utilité de Buildroot se situe principalement dans sa capacité à gérer les dépendances pour la compilation, exactement comme Portage le fait dans Gentoo.</p>
<p>Voici les grandes lignes pour produire un système fonctionnel.</p>
<p>Commençons par récupérer Buildroot:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="fu">git</span> clone https://github.com/buildroot/buildroot</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="bu">cd</span> buildroot</a></code></pre></div>
<p>Charger la configuration par défaut pour Raspberry Pi 2 (sera ajustée à nos besoins par la suite):</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="fu">make</span> raspberrypi2_defconfig</a></code></pre></div>
<p>Paramétrer le système (basé sur <code>raspberrypi2_defconfig</code>), les applications à inclure et l’image en sortie. Si on utilise <code>U-Boot</code> comme bootloader, mettre la valeur <code>rpi</code> dans <code>Bootloaders &gt; Select U-Boot &gt; U-Boot board name</code></p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="fu">make</span> menuconfig</a></code></pre></div>
<p>Sauvegarder la configuration Buildroot si on veut la stocker quelque part en particulier:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="fu">make</span> savedefconfig BR2_DEFCONFIG=./buildroot_config</a></code></pre></div>
<p>Pour la charger dans Buildroot:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="fu">make</span> defconfig BR2_DEFCONFIG=./buildroot_config</a></code></pre></div>
<p>Copier la configuration du noyau (supprimée après un <code>make clean</code>):</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="fu">mkdir</span> -p output/build/linux-custom/</a>
<a class="sourceLine" id="cb6-2" data-line-number="2"><span class="fu">cp</span> kernel_config output/build/linux-custom/.config</a></code></pre></div>
<p>Paramétrer le noyau:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="fu">make</span> linux-menuconfig</a></code></pre></div>
<p>On a tendance à vouloir retirer beaucoup de chose dans le noyau (supports de périphériques multimédia, radioamateur, joystick, etc.), il peut arriver de retirer quelque chose d’essentiel ou une dépendance ce qui se traduira par quelque chose de non fonctionnel. Cela a été mon cas avec le driver pour l’interface Ethernet <a href="https://cateee.net/lkddb/web-lkddb/USB_NET_SMSC95XX.html">SMSC95XX</a> dans <code>Devices Drivers &gt; Network Device Support &gt; USB Network Adapters &gt; SMSC LAN95XX based USB 2.0 10/100 ethernet devices</code> qui dépendait de <code>Multi-purpose USB Networking Framework</code>.</p>
<p>Pour recompiler le noyau uniquement après un changement dans sa configuration:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="fu">make</span> linux-build</a></code></pre></div>
<p>Paramétrer Busybox:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="fu">make</span> busybox-menuconfig</a></code></pre></div>
<p>Paramétrer UBoot (si utilisé):</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="fu">make</span> uboot-menuconfig</a></code></pre></div>
<p>Lancer la compilation:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="fu">make</span></a></code></pre></div>
<p>Après un long moment de compilation (notamment pour la toolchain), l’image devrait être disponible dans <code>output/images/</code>. Au final je suis parvenu à un partition <code>/</code> de 30Mo, <code>/boot</code> de 10Mo et une utilisation de la RAM sur le Raspberry ne dépasse pas 16Mo. Il aurait été possible de descendre encore en retirant des éléments dans BusyBox.</p>
<h2 id="tests-avec-qemu">Tests avec Qemu</h2>
<p>L’image générée après compilation m’a posée problème avec Qemu pour faire mes tests: il semble y avoir un problème d’offset dans la table de partition bien que le Raspberry Pi arrive parfaitement à exécuter le système. J’ai donc généré moi même l’image depuis l’archive <code>rootfs.tar.gz</code> et <code>boot.vfat</code> produits par Buildroot avec le script suivant (utilise <code>bsdtar</code> et nécessite <code>sudo</code> pour l’exécution):</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb12-1" data-line-number="1"><span class="va">IMG_SIZE=</span><span class="st">&quot;60M&quot;</span></a>
<a class="sourceLine" id="cb12-2" data-line-number="2"><span class="va">IMG_DIR=</span><span class="st">&quot;/opt/buildroot/buildroot/output/images&quot;</span></a>
<a class="sourceLine" id="cb12-3" data-line-number="3"><span class="va">IMG_OUTPUT=</span><span class="st">&quot;rpi2.img&quot;</span></a>
<a class="sourceLine" id="cb12-4" data-line-number="4"></a>
<a class="sourceLine" id="cb12-5" data-line-number="5"><span class="bu">echo</span> -e <span class="st">&quot;\nCREATING IMAGE FILE&quot;</span></a>
<a class="sourceLine" id="cb12-6" data-line-number="6"><span class="fu">rm</span> -f <span class="st">&quot;</span><span class="va">$IMG_OUTPUT</span><span class="st">&quot;</span></a>
<a class="sourceLine" id="cb12-7" data-line-number="7"><span class="ex">fallocate</span> -l <span class="st">&quot;</span><span class="va">$IMG_SIZE</span><span class="st">&quot;</span> <span class="st">&quot;</span><span class="va">$IMG_OUTPUT</span><span class="st">&quot;</span></a>
<a class="sourceLine" id="cb12-8" data-line-number="8"></a>
<a class="sourceLine" id="cb12-9" data-line-number="9"><span class="bu">echo</span> -e <span class="st">&quot;CREATING IMAGE FILESYSTEMS&quot;</span></a>
<a class="sourceLine" id="cb12-10" data-line-number="10"><span class="va">LOOP=$(</span><span class="ex">losetup</span> -f<span class="va">)</span></a>
<a class="sourceLine" id="cb12-11" data-line-number="11"><span class="ex">losetup</span> <span class="st">&quot;</span><span class="va">$LOOP</span><span class="st">&quot;</span> <span class="st">&quot;</span><span class="va">$IMG_OUTPUT</span><span class="st">&quot;</span></a>
<a class="sourceLine" id="cb12-12" data-line-number="12"></a>
<a class="sourceLine" id="cb12-13" data-line-number="13"><span class="ex">fdisk</span> <span class="st">&quot;</span><span class="va">$LOOP</span><span class="st">&quot;</span> <span class="op">&lt;&lt;EOF</span></a>
<a class="sourceLine" id="cb12-14" data-line-number="14">o</a>
<a class="sourceLine" id="cb12-15" data-line-number="15">n</a>
<a class="sourceLine" id="cb12-16" data-line-number="16">p</a>
<a class="sourceLine" id="cb12-17" data-line-number="17">1</a>
<a class="sourceLine" id="cb12-18" data-line-number="18"></a>
<a class="sourceLine" id="cb12-19" data-line-number="19">+10M</a>
<a class="sourceLine" id="cb12-20" data-line-number="20">t</a>
<a class="sourceLine" id="cb12-21" data-line-number="21">c</a>
<a class="sourceLine" id="cb12-22" data-line-number="22">n</a>
<a class="sourceLine" id="cb12-23" data-line-number="23">p</a>
<a class="sourceLine" id="cb12-24" data-line-number="24">2</a>
<a class="sourceLine" id="cb12-25" data-line-number="25"></a>
<a class="sourceLine" id="cb12-26" data-line-number="26">+50M</a>
<a class="sourceLine" id="cb12-27" data-line-number="27">n</a>
<a class="sourceLine" id="cb12-28" data-line-number="28">p</a>
<a class="sourceLine" id="cb12-29" data-line-number="29">3</a>
<a class="sourceLine" id="cb12-30" data-line-number="30"></a>
<a class="sourceLine" id="cb12-31" data-line-number="31"></a>
<a class="sourceLine" id="cb12-32" data-line-number="32">p</a>
<a class="sourceLine" id="cb12-33" data-line-number="33">w</a>
<a class="sourceLine" id="cb12-34" data-line-number="34">EOF</a>
<a class="sourceLine" id="cb12-35" data-line-number="35"></a>
<a class="sourceLine" id="cb12-36" data-line-number="36">losetup -d &quot;<span class="va">$LOOP</span>&quot;</a>
<a class="sourceLine" id="cb12-37" data-line-number="37">losetup -P &quot;<span class="va">$LOOP</span>&quot; &quot;<span class="va">$IMG_OUTPUT</span>&quot;</a>
<a class="sourceLine" id="cb12-38" data-line-number="38"></a>
<a class="sourceLine" id="cb12-39" data-line-number="39">echo -e &quot;FORMAT IMAGE FILESYSTEMS&quot;</a>
<a class="sourceLine" id="cb12-40" data-line-number="40">sleep 3</a>
<a class="sourceLine" id="cb12-41" data-line-number="41">mkfs.vfat &quot;<span class="va">${LOOP}</span>p1&quot;</a>
<a class="sourceLine" id="cb12-42" data-line-number="42">mkfs.ext4 &quot;<span class="va">${LOOP}</span>p2&quot;</a>
<a class="sourceLine" id="cb12-43" data-line-number="43"></a>
<a class="sourceLine" id="cb12-44" data-line-number="44">echo -e &quot;MOUNTING IMAGE FILESYSTEMS&quot;</a>
<a class="sourceLine" id="cb12-45" data-line-number="45">mkdir -p mnt/boot_temp</a>
<a class="sourceLine" id="cb12-46" data-line-number="46">mount -t vfat -o loop &quot;<span class="va">${IMG_DIR}</span>/boot.vfat&quot; &quot;mnt/boot_temp&quot;</a>
<a class="sourceLine" id="cb12-47" data-line-number="47">mkdir -p mnt/boot</a>
<a class="sourceLine" id="cb12-48" data-line-number="48">mount &quot;<span class="va">${LOOP}</span>p1&quot; mnt/boot</a>
<a class="sourceLine" id="cb12-49" data-line-number="49">mkdir -p mnt/root</a>
<a class="sourceLine" id="cb12-50" data-line-number="50">mount &quot;<span class="va">${LOOP}</span>p2&quot; mnt/root</a>
<a class="sourceLine" id="cb12-51" data-line-number="51"></a>
<a class="sourceLine" id="cb12-52" data-line-number="52">echo -e &quot;EXTRACTING ROOTFS TO IMAGE&quot;</a>
<a class="sourceLine" id="cb12-53" data-line-number="53">bsdtar -xpf &quot;<span class="va">$IMG_DIR</span>/rootfs.tar.gz&quot; -C mnt/root</a>
<a class="sourceLine" id="cb12-54" data-line-number="54">echo -e &quot;EXTRACTING BOOTFS TO IMAGE&quot;</a>
<a class="sourceLine" id="cb12-55" data-line-number="55">cp mnt/boot_temp/* mnt/boot</a>
<a class="sourceLine" id="cb12-56" data-line-number="56"></a>
<a class="sourceLine" id="cb12-57" data-line-number="57">echo -e &quot;UNMOUNTING IMAGE FILESYSTEMS&quot;</a>
<a class="sourceLine" id="cb12-58" data-line-number="58">sync</a>
<a class="sourceLine" id="cb12-59" data-line-number="59">umount mnt/boot mnt/root mnt/boot_temp</a>
<a class="sourceLine" id="cb12-60" data-line-number="60">losetup -d &quot;<span class="va">$LOOP</span>&quot;</a>
<a class="sourceLine" id="cb12-61" data-line-number="61"></a>
<a class="sourceLine" id="cb12-62" data-line-number="62">chown cyril:cyril &quot;<span class="va">$IMG_OUTPUT</span>&quot;</a>
<a class="sourceLine" id="cb12-63" data-line-number="63">echo -e &quot;Done !&quot;</a></code></pre></div>
<p>Lancer l’image avec Qemu pour les tests</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb13-1" data-line-number="1"><span class="ex">qemu-system-arm</span> -M raspi2 -cpu arm1176 -m 1G -smp 4 \</a>
<a class="sourceLine" id="cb13-2" data-line-number="2">-append <span class="st">&quot;ro earlyprintk loglevel=8 console=ttyAMA0,115200 dwc_otg.lpm_enable=0 rootfstype=ext4 root=/dev/mmcblk0p2 rootwait&quot;</span> \</a>
<a class="sourceLine" id="cb13-3" data-line-number="3">-dtb output/images/bcm2709-rpi-2-b.dtb -drive if=sd,driver=raw,file=rpi2.img \</a>
<a class="sourceLine" id="cb13-4" data-line-number="4">-kernel output/images/zImage -serial stdio</a></code></pre></div>
<p>Pour envoyer votre image sur un support physique (carte SD dans notre cas):</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb14-1" data-line-number="1"><span class="fu">dd</span> bs=4M if=rpi2.img of=/dev/mmcblk0 status=progress</a>
<a class="sourceLine" id="cb14-2" data-line-number="2"><span class="fu">sync</span></a></code></pre></div>
<h2 id="modification-manuelle-de-limage">Modification manuelle de l’image</h2>
<p>Il est nécessaire d’ajouter des fichiers <code>.dtb</code> dans la partition <code>/boot</code> afin de faire fonctionner certains composants comme le capteur DS18B20. Pour cela, monter la partition <code>/boot</code> du fichier <code>rpi2.img</code> avec <code>losetup</code> et <code>mount</code> comme dans le script précédent puis:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb15-1" data-line-number="1"><span class="fu">mkdir</span> mnt/boot/overlays</a>
<a class="sourceLine" id="cb15-2" data-line-number="2"><span class="ex">dtc</span> -O dtb -o w1-gpio-overlay.dtb output/build/linux-custom/arch/arm/boot/dts/overlays/w1-gpio-overlay.dts</a>
<a class="sourceLine" id="cb15-3" data-line-number="3"><span class="fu">cp</span> w1-gpio-overlay.dtb mnt/boot/overlays</a>
<a class="sourceLine" id="cb15-4" data-line-number="4"><span class="bu">echo</span> <span class="st">&quot;dtoverlay=w1-gpio,pullup=1,gpiopin=4&quot;</span> <span class="op">&gt;&gt;</span> mnt/boot/config.txt</a></code></pre></div>
<p>Pour faire correctement les choses, il faudrait utiliser un <em>post-script</em> ou encore un <em>overlay</em> dans Builroot pour insérer des fichiers dans l’image produite. C’est également de cette manière qu’il faut intégrer sa partie applicative.</p>
<h2 id="les-bonnes-pratiques">Les bonnes pratiques</h2>
<ul>
<li>Ne pas utiliser le compte <code>root</code> pour l’applicatif, question de sécurité (implique d’utiliser un port réseau &gt; 1024).</li>
<li>Configurer <code>/</code> en lecture seule pour la sécurité et surtout éviter les problème de corruption de la carte SD en cas de coupure électrique.</li>
<li>Ne pas inclure de service d’accès à distance <code>OpenSSH</code>.</li>
<li>Laisser éventuellement un accès physique via un TTY sur la sortie HDMI pour la configuration IP et investiguer en cas de problème.</li>
<li>Ne pas configurer d’autologin sur TTY au boot pour maintenir l’authentification via login/mot de passe.</li>
<li>Inclure les modules <code>iptables</code> dans le noyau et définir des règles de parfeu via <code>initd</code> afin de protéger l’applicatif si l’environnement réseau est jugé incertain.</li>
<li>Lancer l’applicatif via un script <code>initd</code> composée d’une boucle pour le relancer automatiquement en cas de crash.</li>
</ul>
<h2 id="les-alternatives-à-buildroot">Les alternatives à Buildroot</h2>
<p>Il existe d’autres outils pour construire un système embarqué Linux: <a href="https://www.yoctoproject.org/">Yocto</a> est très utilisé dans le domaine, des constructeurs comme Xilinx, Intel et TI fournissent des “layers” pour intégrer des composants matériels/logiciels à votre système.</p>
<p>Citons le très intéressant <a href="https://nerves-project.org/">Nerves</a> qui utilise Buildroot afin de créer un système extrêmement optimisée/minimaliste pour exécuter une machine virtuelle BEAM et des applications Elixir.</p>
<p>Notons également qu’il existe l’équivalent de Buildroot pour FreeBSD: <a href="https://github.com/freebsd/crochet">Crochet</a>.</p>
</article>

<div id="footer">
  <hr />
  <span class="copyrights">© 2018 C. Boyer, contenu sous licence <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.fr">Creative Commons BY-SA-NC 4.0</a>, l'ensemble des codes sources sont sous licence <a href="https://www.gnu.org/licenses/gpl-3.0.fr.html">GNU GPL v3</a>.</span>
</div>

</div>
</body>
</html>
