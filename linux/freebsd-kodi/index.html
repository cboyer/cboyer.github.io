<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="HandheldFriendly" content="True">
  <title>Installation de Kodi sous FreeBSD 13 - C. Boyer</title>
  <meta name="description" content="Installation de Kodi sous FreeBSD 13" />
  <meta name="author" content="C. Boyer" />
  <meta name="keywords" content="FreeBSD, Kodi" />
  <link rel="canonical" href="https://cboyer.github.io/linux/freebsd-kodi" />
  <meta property="og:title" content="Installation de Kodi sous FreeBSD 13 - C. Boyer" />
  <meta property="og:locale" content="fr_CA" />
  <meta property="og:description" content="Installation de Kodi sous FreeBSD 13" />
  <meta property="og:site_name" content="cboyer.github.io" />
  <meta property="og:type" content="website" />
  <meta property="og:updated_time" content="2021-11-22T17:34:14-05:00" />
  <meta property="article:published_time" content="2021-11-12T18:20:14-05:00" />
  <meta property="article:modified_time" content="2021-11-22T17:34:14-05:00" />
  <meta name="robots" content="index,follow">
  <link rel="icon" href="data:;base64,iVBORw0KGgo=">
  <link href="https://cboyer.github.io/atom.xml" rel="alternate" type="application/atom+xml" title="Flux RSS" />
  <style>
    body { margin: 1em; }
    img { max-width: 100%; height: auto; }
    table { margin-top: 1em; }
    @media (min-width: 42em) { body { margin: 1em auto; max-width: 40em; } }
    ul { list-style: none; padding: 0;}
    p code { font-size: 1.24em; }
  </style>
  <style>pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    background-color: #ffffff;
    color: #a0a0a0;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #a0a0a0;  padding-left: 4px; }
div.sourceCode
  { color: #1f1c1b; background-color: #ffffff; }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span { color: #1f1c1b; } /* Normal */
code span.al { color: #bf0303; background-color: #f7e6e6; font-weight: bold; } /* Alert */
code span.an { color: #ca60ca; } /* Annotation */
code span.at { color: #0057ae; } /* Attribute */
code span.bn { color: #b08000; } /* BaseN */
code span.bu { color: #644a9b; font-weight: bold; } /* BuiltIn */
code span.cf { color: #1f1c1b; font-weight: bold; } /* ControlFlow */
code span.ch { color: #924c9d; } /* Char */
code span.cn { color: #aa5500; } /* Constant */
code span.co { color: #898887; } /* Comment */
code span.cv { color: #0095ff; } /* CommentVar */
code span.do { color: #607880; } /* Documentation */
code span.dt { color: #0057ae; } /* DataType */
code span.dv { color: #b08000; } /* DecVal */
code span.er { color: #bf0303; text-decoration: underline; } /* Error */
code span.ex { color: #0095ff; font-weight: bold; } /* Extension */
code span.fl { color: #b08000; } /* Float */
code span.fu { color: #644a9b; } /* Function */
code span.im { color: #ff5500; } /* Import */
code span.in { color: #b08000; } /* Information */
code span.kw { color: #1f1c1b; font-weight: bold; } /* Keyword */
code span.op { color: #1f1c1b; } /* Operator */
code span.ot { color: #006e28; } /* Other */
code span.pp { color: #006e28; } /* Preprocessor */
code span.re { color: #0057ae; background-color: #e0e9f8; } /* RegionMarker */
code span.sc { color: #3daee9; } /* SpecialChar */
code span.ss { color: #ff5500; } /* SpecialString */
code span.st { color: #bf0303; } /* String */
code span.va { color: #0057ae; } /* Variable */
code span.vs { color: #bf0303; } /* VerbatimString */
code span.wa { color: #bf0303; } /* Warning */</style>
</head>
<body>
  <h1>Installation de Kodi sous FreeBSD 13</h1>
  <em>Publié le 2021-11-12, dernière mise à jour: 2021-11-22</em>
<p>Certains paramètres présentés sont spécifiques à la configuration matérielle d'un système avec Intel Braswell.</p>
<h2 id="installation-de-kodi-depuis-les-paquets">Installation de Kodi depuis les paquets</h2>
<h3 id="installation-des-paquets-avec-pkg">Installation des paquets avec pkg</h3>
<pre class="console"><code>pkg install kodi kodi-addon-pvr.iptvsimple libbluray libcec dav1d lcms2 libass libcrossguid curl ffmpeg libfmt fstrcmp lzo2 spdlog sqlite3 taglib waylandpp libGLU xorg-server xinit xorg-drivers drm-kmod xf86-video-intel libva-intel-driver libvdpau-va-gl xterm py38-sqlite3</code></pre>
<p>Charger le module KMS au boot via <code>/etc/rc.conf</code></p>
<pre class="console"><code>sysrc kld_list+=i915kms</code></pre>
<h3 id="configuration-de-xorg">Configuration de Xorg</h3>
<p>Générer automatiquement une configuration élémentaire</p>
<pre class="console"><code>Xorg -configure
mv xorg.conf.new /etc/X11/xorg.conf</code></pre>
<p>Configuration avancée de Xorg, dans <code>/usr/local/etc/X11/xorg.conf.d/monitor.conf</code></p>
<pre class="text"><code>Section &quot;Monitor&quot;
    Identifier   &quot;Monitor0&quot;
    VendorName   &quot;Monitor Vendor&quot;
    ModelName    &quot;Monitor Model&quot;
    Modeline &quot;1920x1080_60.00&quot;  172.80  1920 2040 2248 2576  1080 1081 1084 1118  -HSync +Vsync
    Modeline &quot;3840x2160_30.00&quot;  339.57  3840 4080 4496 5152  2160 2161 2164 2197  -HSync +Vsync
    #Option &quot;PreferredMode&quot; &quot;3840x2160@30.0&quot;
    Option &quot;PreferredMode&quot; &quot;1920x1080@60.0&quot;
EndSection</code></pre>
<p>Pour activer l'accélération matérielle, dans <code>/usr/local/etc/X11/xorg.conf.d/card.conf</code></p>
<pre class="text"><code>Section &quot;Device&quot;
    Identifier &quot;Card0&quot;
    Driver &quot;modesetting&quot;
    Option &quot;DPMS&quot;
    Option &quot;DRI&quot; &quot;3&quot;
    Option &quot;AccelMethod&quot; &quot;glamor&quot;
EndSection</code></pre>
<p>Création du compte utilisateur kodi</p>
<pre class="console"><code>pw user add -n kodi -c &#39;Kodi Media Player&#39; -d /home/kodi -G video -m -s /bin/csh</code></pre>
<blockquote>
<p>Si l'utilisateur kodi peut être crée à l'installation de FreeBSD puis modifié avec <code>pw group mod wheel -m kodi</code> par exemple. Pour changer de shell <code>chsh -s /usr/local/bin/bash kodi</code>.</p>
</blockquote>
<p>Tester l'exécution de Kodi:</p>
<pre class="console"><code>su -m kodi -c &#39;setenv HOME /home/kodi &amp;&amp; /usr/local/bin/xinit /usr/local/bin/kodi-standalone -- -nocursor :0 -nolisten tcp&#39;</code></pre>
<h3 id="autologin-et-lancement-automatique-de-kodi">Autologin et lancement automatique de Kodi</h3>
<p>Dans <code>/etc/gettytab</code></p>
<pre class="text"><code># autologin kodi
A|Al|Autologin console:\
  :ht:np:sp#115200:al=kodi</code></pre>
<p>Dans <code>/etc/ttys</code></p>
<pre class="text"><code>#ttyv1  &quot;/usr/libexec/getty Pc&quot;         xterm   onifexists secure
ttyv1   &quot;/usr/libexec/getty Al&quot;         xterm   onifexists secure</code></pre>
<p>Ajouter dans <code>/home/kodi/.cshrc</code></p>
<div class="sourceCode" id="cb10"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="ex">setenv</span> LIBVA_DRIVER_NAME i965</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="ex">setenv</span> LIBVA_DRIVERS_PATH /usr/local/lib/dri</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="bu">set</span> XPID = <span class="kw">`</span><span class="ex">/usr/bin/pgrep</span> xinit<span class="kw">`</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">(</span> <span class="kw">{</span> <span class="bu">[</span> <span class="ot">-n</span> <span class="st">&quot;</span><span class="va">$XPID</span><span class="st">&quot;</span> <span class="bu">]</span> <span class="kw">}</span> <span class="kw">)</span> <span class="cf">then</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">&quot;X is already running&quot;</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    <span class="ex">/usr/local/bin/xinit</span> /usr/local/bin/kodi-standalone <span class="at">--</span> <span class="at">-nocursor</span> :0 <span class="at">-nolisten</span> tcp</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">logout</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="ex">endif</span></span></code></pre></div>
<h3 id="configuration-du-chargeur-damorçage">Configuration du chargeur d'amorçage</h3>
<p>Ajouter dans <code>/boot/loader.conf</code>.</p>
<pre class="text"><code>autoboot_delay=&quot;-1&quot;
hw.vga.textmode=0
kern.vt.fb.default_mode=&quot;800x600&quot;</code></pre>
<h3 id="support-des-partitions-ext4">Support des partitions EXT4</h3>
<pre class="console"><code>pkg install fusefs-lkl
kldload fusefs
sysrc kld_list+=fusefs</code></pre>
<p>Pour tester</p>
<pre class="console"><code>mount -t fuse -o rw,mountprog=/usr/local/bin/lklfuse,type=ext4,allow_other /dev/ada1s1 /data</code></pre>
<p>Ajouter dans <code>/etc/fstab</code> pour que la partition soit montée au démarrage</p>
<pre class="text"><code>/dev/ada1s1             /data           fuse    rw,mountprog=/usr/local/bin/lklfuse,type=ext4,allow_other,late 0 0</code></pre>
<blockquote>
<p>Pour les volumes NTFS il faut installer le paquet <code>fusefs-ntfs</code>.</p>
</blockquote>
<h3 id="installation-de-samba4">Installation de Samba4</h3>
<p>pkg install samba413</p>
<p>La configuration dans <code>/usr/local/etc/smb4.conf</code></p>
<pre class="text"><code>[global]
    workgroup = WORKGROUP
    realm = WORKGROUP
    netbios name = kodi

[data]
    path = /data
    public = no
    writable = yes
    printable = no
    guest ok = no
    valid users = smbuser</code></pre>
<pre class="console"><code>sysrc samba_server_enable=&quot;YES&quot;
service samba_server start</code></pre>
<h2 id="compilation-et-installation-de-kodi-avec-les-portssources-uniquement">Compilation et installation de Kodi avec les ports/sources uniquement</h2>
<h3 id="récupèration-des-ports-et-installation-des-outils">Récupèration des ports et installation des outils</h3>
<p>Définition de certaines options par défaut lors de la compilation des ports dans <code>/etc/make.conf</code></p>
<pre class="text"><code>DEFAULT_VERSIONS= python=3.9 python3=3.9
OPTIONS_UNSET= X11 GUI CUPS DOCS EXAMPLES DOXYGEN PERL LUA
WITHOUT= X11 GUI CUPS DOCS EXAMPLES DOXYGEN PERL LUA

#Pour un port particulier
#devel_gettext-tools_UNSET+=EXAMPLES</code></pre>
<p>Installation de l'arbre des ports et portmaster</p>
<pre class="console"><code>portsnap fetch extract
cd /usr/ports
cd /usr/ports/ports-mgmt/portmaster
make install clean
rehash
portmaster -L</code></pre>
<p>L'outil <code>portmaster</code> permet l'installation de ports à la place de <code>make install clean</code>. Quelques paramètres utiles pour l'utilisation de <code>portmaster</code>:</p>
<ul>
<li><code>-P</code> permet d'utiliser les paquets précompilés pour les dépendances</li>
<li><code>-G</code> accepter la configuration par défaut (pas d'interaction)</li>
<li><code>-B</code> ne conserve pas de backup de l'ancien package après mise à jour (pas d'interaction)</li>
<li><code>-d</code> nettoie les distfiles</li>
</ul>
<p>Les commandes complémentaires pour la gestion des ports:</p>
<pre class="console"><code>#Chercher un port par son nom (depuis /usr/ports)
make quicksearch name=htop

#Configurer le port courant et ses dépendances
make config-recursive

#Pour supprimer la configuration du port et ses dépendances
make rmconfig-recursive

#Pour tout nettoyer (depuis /usr/ports)
find -s . -type d -name &#39;work&#39; -exec make rmconfig &#39;{}&#39; \; -exec make clean &#39;{}&#39; \;</code></pre>
<p>Installation de <code>git</code> et <code>cmake</code></p>
<pre class="console"><code>portmaster devel/git@tiny devel/cmake</code></pre>
<h3 id="installation-des-ports">Installation des ports</h3>
<p>Installer les sources du noyau pour la version/architecture courante (nécessaire pour compiler certains pilotes par la suite)</p>
<pre class="console"><code>cd /tmp
fetch ftp://ftp.freebsd.org/pub/FreeBSD/releases/amd64/13.0-RELEASE/src.txz
tar -C / -zxvf src.txz
rm /tmp/src.txz</code></pre>
<p>Installer le pilote DRM</p>
<pre class="console"><code>portmaster -Bd graphics/drm-kmod
sysrc kld_list+=i915kms
kldload i915kms</code></pre>
<p>Installer le pilote i965 (non contenu dans mesa-dri) et VAAPI pour le décodage matériel</p>
<pre class="console"><code>cd graphics/mesa-devel
make config
portmaster -Bd graphics/mesa-devel
portmaster -Bd multimedia/libva-intel-driver</code></pre>
<p>Configuration et compilation de Kodi (options GBM/OpenGLES pour se passer du serveur X)</p>
<pre class="console"><code>cd /usr/ports/multimedia/kodi
make config
portmaster -Bd --update-if-newer multimedia/kodi
mkdir /usr/local/lib/kodi/addons</code></pre>
<h3 id="compilation-des-addons-kodi-depuis-les-sources">Compilation des addons Kodi depuis les sources</h3>
<h4 id="ipvr-simple-client">IPVR Simple Client</h4>
<p>La version de Kodi issue des ports appartient à la branche Matrix (version 19), IPVR Simple Client doit être issu de la même branche pour assurer sa compatibilité.</p>
<pre class="console"><code>cd /tmp
git clone --branch 19.3-Matrix https://github.com/xbmc/xbmc.git
git clone --depth 1 --branch 19.0.2-Matrix https://github.com/kodi-pvr/pvr.iptvsimple
cd pvr.iptvsimple &amp;&amp; mkdir build &amp;&amp; cd build
cmake -DADDONS_TO_BUILD=pvr.iptvsimple -DADDON_SRC_PREFIX=../.. -DCMAKE_BUILD_TYPE=Debug -DCMAKE_INSTALL_PREFIX=../../xbmc/addons -DPACKAGE_ZIP=1 ../../xbmc/cmake/addons</code></pre>
<p>Ajouter <code>-fPIC</code> dans les directives de <code>CMakeCache.txt</code></p>
<pre class="text"><code>CMAKE_CXX_FLAGS:STRING=-fPIC
CMAKE_C_FLAGS:STRING=-fPIC</code></pre>
<p>Lancer la compilation et copier les fichiers</p>
<pre class="console"><code>make
mkdir /usr/local/lib/kodi/addons/pvr.iptvsimple/
mkdir /usr/local/share/kodi/addons/pvr.iptvsimple/

cp ../../xbmc/addons/pvr.iptvsimple/pvr.iptvsimple.so* /usr/local/lib/kodi/addons/pvr.iptvsimple/
cp ../../xbmc/addons/pvr.iptvsimple/addon.xml /usr/local/share/kodi/addons/pvr.iptvsimple/
cp ../../xbmc/addons/pvr.iptvsimple/changelog.txt /usr/local/share/kodi/addons/pvr.iptvsimple/
cp ../../xbmc/addons/pvr.iptvsimple/icon.png /usr/local/share/kodi/addons/pvr.iptvsimple/
cp -r ../../xbmc/addons/pvr.iptvsimple/resources/ /usr/local/share/kodi/addons/pvr.iptvsimple/resources</code></pre>
<h4 id="inputstream.ffmpegdirect">inputstream.ffmpegdirect</h4>
<pre class="console"><code>cd /tmp
git clone --depth 1 --branch Matrix https://github.com/xbmc/inputstream.ffmpegdirect.git
cd inputstream.ffmpegdirect &amp;&amp; mkdir build &amp;&amp; cd build
cmake -DADDONS_TO_BUILD=inputstream.ffmpegdirect -DADDON_SRC_PREFIX=../.. -DCMAKE_BUILD_TYPE=Debug -DCMAKE_INSTALL_PREFIX=../../xbmc/build/addons -DPACKAGE_ZIP=1 ../../xbmc/cmake/addons
gmake

mkdir /usr/local/lib/kodi/addons/inputstream.ffmpegdirect
mkdir /usr/local/share/kodi/addons/inputstream.ffmpegdirect

cp ../../xbmc/build/addons/inputstream.ffmpegdirect/inputstream.ffmpegdirect.so* /usr/local/lib/kodi/addons/inputstream.ffmpegdirect
cp ../../xbmc/build/addons/inputstream.ffmpegdirect/addon.xml /usr/local/share/kodi/addons/inputstream.ffmpegdirect
cp ../../xbmc/build/addons/inputstream.ffmpegdirect/changelog.txt /usr/local/share/kodi/addons/inputstream.ffmpegdirect
cp ../../xbmc/build/addons/inputstream.ffmpegdirect/icon.png /usr/local/share/kodi/addons/inputstream.ffmpegdirect
cp -r ../../xbmc/build/addons/inputstream.ffmpegdirect/resources/ /usr/local/share/kodi/addons/inputstream.ffmpegdirect/resources</code></pre>
<h4 id="inputstream.adaptive">inputstream.adaptive</h4>
<pre class="console"><code>cd /tmp
git clone --depth 1 --branch Matrix https://github.com/xbmc/inputstream.adaptive
cd inputstream.adaptive &amp;&amp; mkdir build &amp;&amp; cd build
cmake -DADDONS_TO_BUILD=inputstream.adaptive -DADDON_SRC_PREFIX=../.. -DCMAKE_BUILD_TYPE=Debug -DCMAKE_INSTALL_PREFIX=../../xbmc/build/addons -DPACKAGE_ZIP=1 ../../xbmc/cmake/addons
gmake

mkdir /usr/local/lib/kodi/addons/inputstream.adaptive
mkdir /usr/local/share/kodi/addons/inputstream.adaptive

cp ../../xbmc/build/addons/inputstream.adaptive/inputstream.adaptive.so* /usr/local/lib/kodi/addons/inputstream.adaptive
cp ../../xbmc/build/addons/inputstream.adaptive/libssd_wv.so /usr/local/lib/kodi/addons/inputstream.adaptive
cp ../../xbmc/build/addons/inputstream.adaptive/addon.xml /usr/local/share/kodi/addons/inputstream.adaptive
cp -r ../../xbmc/build/addons/inputstream.adaptive/resources/ /usr/local/share/kodi/addons/inputstream.adaptive/resources</code></pre>
<h4 id="inputstream.rtmp">inputstream.rtmp</h4>
<pre class="console"><code>cd /tmp
git clone --depth 1 --branch Matrix https://github.com/xbmc/inputstream.rtmp
cd inputstream.rtmp &amp;&amp; mkdir build &amp;&amp; cd build
cmake -DADDONS_TO_BUILD=inputstream.rtmp -DADDON_SRC_PREFIX=../.. -DCMAKE_BUILD_TYPE=Debug -DCMAKE_INSTALL_PREFIX=../../xbmc/kodi-build/addons -DPACKAGE_ZIP=1 ../../xbmc/cmake/addons</code></pre>
<p>Ajouter <code>set(OPENSSL_TARGET BSD-x86_64)</code> dans <code>../depends/common/openssl/CMakeLists.txt</code> avant la suite de fonctions <code>list</code>. Ajouter <code>-fPIC</code> dans les directives de <code>CMakeCache.txt</code></p>
<pre class="text"><code>CMAKE_CXX_FLAGS:STRING=-fPIC
CMAKE_C_FLAGS:STRING=-fPIC</code></pre>
<p>Lancer la compilation et copier les fichiers</p>
<pre class="console"><code>make
mkdir /usr/local/lib/kodi/addons/inputstream.rtmp
mkdir /usr/local/share/kodi/addons/inputstream.rtmp

cp ../../xbmc/kodi-build/addons/inputstream.rtmp/inputstream.rtmp.so* /usr/local/lib/kodi/addons/inputstream.rtmp
cp ../../xbmc/kodi-build/addons/inputstream.rtmp/addon.xml /usr/local/share/kodi/addons/inputstream.rtmp
cp ../../xbmc/kodi-build/addons/inputstream.rtmp/icon.png /usr/local/share/kodi/addons/inputstream.rtmp
cp -r ../../xbmc/kodi-build/addons/inputstream.rtmp/resources/ /usr/local/share/kodi/addons/inputstream.rtmp/resources</code></pre>
<h3 id="lectures-complémentaires">Lectures complémentaires</h3>
<ul>
<li><a href="https://docs.freebsd.org/en/books/handbook/ports/">https://docs.freebsd.org/en/books/handbook/ports/</a></li>
<li><a href="https://amissing.link/freebsd-entertainment-center.html">https://amissing.link/freebsd-entertainment-center.html</a></li>
<li><a href="https://forums.freebsd.org/threads/trouble-calling-startx-in-start-up-script.22304/#post-125992">https://forums.freebsd.org/threads/trouble-calling-startx-in-start-up-script.22304/#post-125992</a></li>
<li><a href="https://forums.freebsd.org/threads/mounting-a-logical-ext4-partition-in-freebsd.72286/">https://forums.freebsd.org/threads/mounting-a-logical-ext4-partition-in-freebsd.72286/</a></li>
</ul>
  <em>©2015-2022 C. Boyer, contenu sous <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.fr">CC BY-SA-NC 4.0</a>, codes sources sous <a href="https://www.gnu.org/licenses/gpl-3.0.fr.html">GNU GPL v3</a></em>
</body>
</html>
